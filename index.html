<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
	<title>æ— å¤„ä¸åœ¨çš„ UTF-8</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<link rel="stylesheet" type="text/css" href="data/style.css"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>
</head>
<body>
<div class="topDiv">
<h1><a class="aId" href="#">æ— å¤„ä¸åœ¨çš„ UTF-8</a></h1>
<p class="subtitle">å®£è¨€</p>

<h2 id="intro"><a class="aId" href="#intro">è¿™ä»½æ–‡æ¡£çš„ç›®çš„</a></h2>

<aside class="rightFloater">è¿™ä»½æ–‡æ¡£åŒ…å«ç‰¹æ®Šå­—ç¬¦ã€‚å¦‚æœæ²¡æœ‰åˆé€‚çš„æ¸²æŸ“æ”¯æŒï¼Œä½ ä¹Ÿè®¸ä¼šçœ‹åˆ°é—®å·ï¼Œæ–¹å—æˆ–å…¶å®ƒç¬¦å·ã€‚</aside>


<p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä¿ƒè¿› UTF-8 ç¼–ç çš„ä½¿ç”¨ä¸æ”¯æŒï¼Œè®©äººä»¬ç¡®ä¿¡ UTF-8 ç¼–ç åº”è¯¥æ˜¯åœ¨å†…å­˜æˆ–ç£ç›˜ä¸­å­˜å‚¨æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œç”¨äºæ²Ÿé€šå’Œæ‰€æœ‰å…¶ä»–ç”¨é€”çš„é»˜è®¤ç¼–ç é€‰æ‹©ã€‚æˆ‘ä»¬ç›¸ä¿¡æˆ‘ä»¬çš„æ–¹æ¡ˆæå‡äº†æ€§èƒ½ï¼Œé™ä½äº†è½¯ä»¶çš„å¤æ‚åº¦å¹¶ä¸”é¿å…äº†å¾ˆå¤š Unicode ç›¸å…³çš„é”™è¯¯ã€‚æˆ‘ä»¬ç›¸ä¿¡æ‰€æœ‰å…¶å®ƒ Unicodeï¼ˆæˆ–æ–‡æœ¬ï¼‰çš„ç¼–ç é€‚ç”¨äºä¼˜åŒ–æå°‘çš„è¾¹ç•Œæƒ…å†µï¼Œä¸»æµç”¨æˆ·åº”è¯¥é¿å…ä½¿ç”¨ã€‚</p>

<p>ç‰¹åˆ«åœ°ï¼Œæˆ‘ä»¬è®¤ä¸ºéå¸¸æµè¡Œçš„ UTF-16 ç¼–ç ï¼ˆåœ¨ Windows ä¸–ç•Œè¢«é”™ç”¨åšå®½å­—ç¬¦ï¼ˆwidecharï¼‰å’Œ Unicode çš„åŒä¹‰è¯ï¼‰ä¸åº”è¯¥ç”¨åœ¨åº“ APIs ä¸­ï¼Œé™¤éç”¨äºå¤„ç†æ–‡æœ¬çš„ç‰¹æ®Šçš„åº“å¦‚ ICUã€‚</p>

<p>æœ¬æ–‡æ¡£å»ºè®®åœ¨ Windows åº”ç”¨ç¨‹åºä¸­ä¹Ÿä½¿ç”¨ UTF-8 ç¼–ç å­˜å‚¨å­—ç¬¦ä¸²ï¼Œå°½ç®¡ç”±äºå†å²åŸå› å’ŒåŸç”ŸAPIçº§åˆ« UTF-8 æ”¯æŒçš„ç¼ºä¹è¿™ä¸ªæ ‡å‡†åœ¨è¿™ä¸ªé¢†åŸŸå¹¶ä¸æµè¡Œã€‚æˆ‘ä»¬ç›¸ä¿¡å³ä½¿åœ¨è¿™ä¸ªå¹³å°ä¸Šï¼Œåé¢çš„ä¸€äº›è§‚ç‚¹èƒœè¿‡åŸç”Ÿæ”¯æŒçš„ç¼ºä¹ã€‚å¹¶ä¸”ï¼Œæˆ‘ä»¬å»ºè®®æ°¸è¿œå¿˜è®°å†…ç è¡¨ï¼ˆANSI codepagesï¼‰å’Œå®ƒä»¬çš„ç”¨é€”ã€‚åœ¨æ–‡æœ¬å­—ç¬¦ä¸²ä¸­æ··ç”¨ä»»æ„ç§è¯­è¨€æ˜¯å±äºç”¨æˆ·çš„æƒåˆ©ã€‚</p>

<p>åœ¨å·¥ä¸šä¸Šï¼Œå¾ˆå¤šæœ¬åœ°åŒ–ç›¸å…³çš„ bugs <a href="http://www.joelonsoftware.com/articles/Unicode.html">æºäº</a>ç¨‹åºå‘˜ç¼ºä¹ Unicode ç¼–ç çŸ¥è¯†ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬è®¤ä¸ºï¼Œå¦‚æœä¸€ä¸ªåº”ç”¨ä¸æ˜¯ä¸“ä¸šç”¨äºæ–‡æœ¬ï¼Œå®ƒçš„æ¶æ„åº”è¯¥èƒ½å¤Ÿè®©ç¨‹åºæ— éœ€è€ƒè™‘ç¼–ç é—®é¢˜ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œä¸€ä¸ªæ–‡ä»¶å¤åˆ¶å·¥å…·ä¸åº”è¯¥ä¸ºäº†æ”¯æŒéè‹±è¯­æ–‡ä»¶åè€Œå†™çš„ä¸åŒã€‚åœ¨è¿™ä»½å®£è¨€é‡Œï¼Œæˆ‘ä»¬è¿˜å°†å‘Šè¯‰ä¸€ä¸ªç¨‹åºå‘˜å¦‚æœä»–ä¸æƒ³é™·å…¥ Unicode çš„å¤æ‚ä¹‹ä¸­å¹¶ä¸”ä¸å…³å¿ƒ <a href="#cookie">å­—ç¬¦ä¸²çš„å†…éƒ¨</a>ï¼Œä»–åº”è¯¥æ€ä¹ˆåšã€‚</p>

<p>æ­¤å¤–ï¼Œåœ¨æ–‡æœ¬å¤„ç†æƒ…æ™¯ä¸­ï¼Œæˆ‘ä»¬å»ºè®®ä¸åº”è¯¥å°†è®¡æ•°æˆ–è€…éå† Unicode ç ç‚¹è§†ä¸ºç‰¹åˆ«é‡è¦çš„ä»»åŠ¡ã€‚è®¸å¤šå¼€å‘è€…é”™è¯¯åœ°å°†ç ç‚¹è§†ä¸º ASCII å­—ç¬¦çš„ç»§æ‰¿ã€‚è¿™å¯¼è‡´äº†åƒ Python å­—ç¬¦ä¸² O(1) ç ç‚¹è·å–ã€‚ç„¶è€Œï¼Œäº‹å®ä¸Š Unicode éå¸¸å¤æ‚å¹¶ä¸”æ²¡æœ‰åƒ <em>Unicode å­—ç¬¦</em>è¿™æ ·çš„é€šç”¨å®šä¹‰ã€‚ç›¸å¯¹ä¸ Uncoide å­—ç¬¦æ—ï¼Œç å…ƒæˆ–è€…ç”šè‡³è¯­è¨€ä¸­çš„å•è¯ï¼Œæˆ‘ä»¬æ²¡æœ‰ç‰¹æ®Šçš„åŸå› å»æ›´é’ç Unicode ç ç‚¹ã€‚å¦ä¸€æ–¹é¢ï¼Œå°† UTF-8 ç å…ƒè§†ä¸ºä¸€ä¸ªæ–‡æœ¬çš„åŸºæœ¬å•å…ƒå¯¹äºå¾ˆå¤šä»»åŠ¡æ¥è¯´ç‰¹åˆ«æœ‰ç”¨ï¼Œå¦‚è§£æå¸¸ç”¨çš„å­—ç¬¦æ•°æ®ç±»å‹ã€‚è¿™æºäºè¿™ç§ç¼–ç çš„ç‰¹æ€§ã€‚å­—ä½ï¼Œç å…ƒï¼Œç ç‚¹å’Œå…¶ä»–ç›¸å…³çš„ Unicode ç›¸å…³çš„æœ¯è¯­åœ¨ <a href="#characters">éƒ¨åˆ† 5 </a>æœ‰è§£é‡Šã€‚ç¼–ç å­—ç¬¦ä¸²çš„æ“ä½œåœ¨ <a href="#textops">éƒ¨åˆ† 7</a> æœ‰è®¨è®ºã€‚</p>

<h2 id="background"><a class="aId" href="#background">èƒŒæ™¯</a></h2>

<p>1988å¹´ï¼ŒJoseph D. Becker å‘å¸ƒäº†<a href="http://unicode.org/history/unicode88.pdf">ç¬¬ä¸€ä¸ª Unicode è‰æ¡ˆæè®®</a>ã€‚ä»–çš„è®¾è®¡çš„æ ¹æ®æ˜¯ä¸€ä¸ªå¤©çœŸçš„å‡è®¾:æ¯ä¸ªå­—ç¬¦ 16 ä½å°±è¶³å¤Ÿã€‚åœ¨1991å¹´ï¼ŒUnicode æ ‡å‡†çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬å‘å¸ƒï¼Œç ç‚¹è¢«é™åˆ¶åœ¨16ä½ã€‚åœ¨æ¥ä¸‹æ¥çš„å‡ å¹´ä¸­ï¼Œè®¸å¤šç³»ç»Ÿæ·»åŠ äº†å¯¹ Unicode çš„æ”¯æŒå¹¶ä¸”è½¬æ¢åˆ°äº† UCS-2 ç¼–ç ã€‚å¯¹äºåƒQtæ¡†æ¶ï¼Œ(1992)ï¼ŒWindows NT 3.1(1993)å’Œ Java (1995)ç­‰å½“æ—¶çš„æ–°æŠ€æœ¯ï¼Œå®ƒæ˜¯éå¸¸æœ‰å¸å¼•åŠ›çš„ã€‚</p>

<p>ç„¶è€Œï¼Œå¾ˆå¿«å°±å‘ç°æ¯ä¸ªå­—ç¬¦16ä½å¯¹äº Unicode æ˜¯ä¸å¤Ÿçš„ã€‚åœ¨1996å¹´ï¼ŒUTF-16ç¼–ç è¢«åˆ›é€ å‡ºæ¥ï¼Œä»è€Œä½¿ç°å­˜çš„ç³»ç»Ÿèƒ½å¤Ÿå¤„ç†é16ä½çš„å­—ç¬¦ã€‚è¿™ä½¿å¾—æœ€åˆé€‰ç”¨16ä½å­—ç¬¦ç¼–ç ï¼Œä¹Ÿå°±æ˜¯å›ºå®šå®½åº¦ç¼–ç çš„ç†è®ºæ²¡æœ‰äº†ä¾æ®ã€‚ç°åœ¨ï¼ŒUnicode åŒ…å«è¶…è¿‡109449ä¸ªå­—ç¬¦ï¼Œå…¶ä¸­å¤§çº¦74500ä¸ªå±äºä¸­æ—¥éŸ©ï¼ˆCJKï¼‰ç»Ÿä¸€è¡¨æ„æ–‡å­—ã€‚</p>

<div style="text-align:center">
	<img src="data/nagoya-museum.jpg" style="text-align: center; max-width: 100%; width: 480px;" alt="A little child playing an encodings game in front of a large poster about encodings."/>
	<div style="font-style: italic; margin:1ex;">åå¤å±‹ç§‘å­¦åšç‰©é¦†ã€‚Vadim Zlotnik æ‘„ã€‚</div>
</div>

<p>å¾®è½¯ç»å¸¸é”™è¯¯åœ°å°† Unicode å’Œå®½å­—ç¬¦ (widechar) ä½œä¸ºäº† UCS-2 å’Œ UTF-16 çš„åŒä¹‰è¯ã€‚è€Œä¸”ï¼Œå› ä¸º UTF-8 ä¸èƒ½è¢«è®¾ç½®ä¸ºçª„å­—ç¬¦ä¸²çš„ WinAPI çš„ç¼–ç ï¼Œäººä»¬å¿…é¡»å®šä¹‰ <code>UNICODE</code> ç¼–è¯‘ä»£ç ã€‚Windows C++ ç¨‹åºå‘˜è¢«æ•™è‚² Unicode å¿…é¡»å’Œå®½å­—ç¬¦ï¼ˆç”šè‡³æ˜¯ä½¿ç”¨ä¸ç¼–è¯‘å™¨è®¾ç½®ç›¸å…³çš„TCHARsï¼Œå…è®¸ç¨‹åºå‘˜ä¸æ”¯æŒå…¨éƒ¨çš„ Unicode ç ç‚¹ï¼‰ä¸€èµ·ä½¿ç”¨ã€‚ä½œä¸ºè¿™äº›æ··ä¹±çš„ç»“æœï¼Œè®¸å¤š Windows ç¨‹åºå‘˜åœ¨å…³äºå¦‚ä½•æ­£ç¡®å¤„ç†æ–‡æœ¬éå¸¸ç–‘æƒ‘ã€‚</p>

<p>ä¸æ­¤åŒæ—¶ï¼Œåœ¨ Linux å’Œ Web ä¸–ç•Œé‡Œï¼Œæœ‰ä¸€ä¸ªé»˜è®¤çš„å…±è¯†ï¼šUTF-8 æ˜¯åœ°çƒä¸Šå¯¹ Unicode æœ€å¥½çš„ç¼–ç ã€‚å°½ç®¡ç›¸å¯¹äºå…¶å®ƒçš„æ–‡æœ¬ï¼Œå®ƒå¯¹è‹±è¯­ï¼ŒåŒ…æ‹¬è®¡ç®—æœºè¯­è¨€ï¼ˆä¾‹å¦‚ C++ï¼ŒHTMLï¼ŒXMLç­‰ï¼‰æä¾›äº†æ›´çŸ­çš„è¡¨ç¤ºï¼Œåœ¨å¸¸ç”¨çš„å­—ç¬¦é›†ä¸Šï¼Œå®ƒä¹Ÿå¾ˆå°‘æ¯” UTF-16 ç¼–ç æ•ˆç‡ä½ã€‚</p>

<h2 id="facts"><a class="aId" href="#facts">äº‹å®</a></h2>

<ul>
	<li>åœ¨ UTF-8 å’Œ UTF-16 ç¼–ç ä¸­ï¼Œç ç‚¹éƒ½æ˜¯æœ€å¤šå æ® 4 ä¸ªå­—èŠ‚ã€‚</li>

	<li>UTF-8 æ˜¯ç«¯æ€§ä¸­ç«‹çš„ã€‚UTF-16 æœ‰ä¸¤ç§æ ¼å¼ï¼šUTF-16LE å’Œ UTF-16BEï¼ˆåˆ†åˆ«å¯¹åº”ä¸åŒçš„å­—èŠ‚åºï¼‰ã€‚è¿™é‡Œæˆ‘ä»¬å°†ä»–ä»¬ç»Ÿç§°ä¸ºUTF-16ã€‚</li>

	<li>å®½å­—ç¬¦ï¼ˆwidecharï¼‰åœ¨ä¸€äº›å¹³å°ä¸Š2ä¸ªå­—èŠ‚å¤§å°ï¼Œåœ¨å…¶ä»–å¹³å°ä¸Š4ä¸ªå­—èŠ‚ã€‚</li>

	<li>å½“æŒ‰å­—å…¸åºæ’åºçš„æ—¶å€™ï¼ŒUTF-8 å’Œ UTF-32 é¡ºåºç›¸åŒï¼ŒUTF-16åˆ™ä¸åŒã€‚</li>

	<li>UTF-8 ç¼–ç å¤„ç†åœ¨è‹±è¯­å­—æ¯å’Œå…¶å®ƒ ASCII å­—ç¬¦ä¸Šæ•ˆç‡æ›´é«˜ï¼ˆæ¯ä¸ªå­—ç¬¦ä¸€ä¸ªå­—èŠ‚ï¼‰ï¼Œè€Œ UTF-16 ç¼–ç åˆ™åœ¨å¤„ç†å‡ ä¸ªäºšæ´²å­—ç¬¦é›†ä¸Šæ•ˆç‡æ›´å¥½ï¼ˆæ¯ä¸ªå­—ç¬¦ä¸¤ä¸ªå­—èŠ‚è€Œä¸æ˜¯ UTF-8ç¼–ç ä¸­çš„3ä¸ªï¼‰ã€‚åœ¨ Web ä¸–ç•Œä¸­ï¼Œè‹±è¯­çš„ HTML/XML æ ‡ç­¾å’Œå„ç§æ–‡æœ¬æ··åœ¨ä¸€èµ·ï¼Œè¿™ä½¿å¾— UTF-8 æˆä¸ºäº†æœ€å—æ¬¢è¿çš„é€‰æ‹©ã€‚è¥¿é‡Œå°”å­—æ¯ï¼Œå¸Œä¼¯æ¥è¯­å’Œå‡ ä¸ªå…¶å®ƒæµè¡Œçš„ Unicode å­—ç¬¦è¡¨å—åœ¨ UTF-16 å’Œ UTF-8 ä¸­éƒ½æ˜¯ 2 ä¸ªå­—èŠ‚ã€‚</li>

	<li>UTF-16 ç»å¸¸è¢«è¯¯ç”¨åšå›ºå®šå®½åº¦çš„ç¼–ç ï¼Œå³ä½¿åœ¨ Windows åŸç”Ÿåº”ç”¨ä¸­ï¼šåœ¨æ™®é€šæ–‡æœ¬ç¼–è¾‘æ§åˆ¶ä¸­ï¼ˆç›´åˆ° Vistaï¼‰,åˆ é™¤ä¸€ä¸ªåœ¨ UTF-16 ä¸­å æ® 4 ä¸ªå­—èŠ‚çš„å­—ç¬¦ï¼Œè¦ä½¿ç”¨ä¸¤ä¸ªé€€æ ¼é”®ã€‚åœ¨ Windows 7ä¸­ï¼Œæ§åˆ¶å°å°†è¯¥å­—ç¬¦æ˜¾ç¤ºä¸ºä¸¤ä¸ªæ— æ•ˆå­—ç¬¦ï¼Œæ— è®ºä½¿ç”¨ä»€ä¹ˆå­—ä½“ã€‚</li>

	<li>è®¸å¤š Windows ç¬¬ä¸‰æ–¹åº“ä¸æ”¯æŒ Unicodeï¼šå®ƒä»¬ä½¿ç”¨çª„å­—ç¬¦ä¸²å‚æ•°å¹¶ä¸”å°†å®ƒä»¬ä¼ é€’ç»™ ANSI APIã€‚å³ä½¿æ–‡ä»¶åä¹Ÿæ˜¯è¿™æ ·ã€‚æ€»çš„æ¥è¯´ï¼Œè¿™æ ·æ˜¯è¡Œä¸é€šçš„ï¼Œå› ä¸ºå­—ç¬¦ä¸²ä¸å¯èƒ½ä½¿ç”¨ä¸€ä¸ª ANSI é¡µç è¡¨ç¤ºå®Œå…¨ï¼ˆå¦‚æœå®ƒåŒ…å«æ¥è‡ªä¸åŒ Unicode åŒºå—çš„å­—ç¬¦ï¼‰ã€‚åœ¨ Windows ä¸Šè§£å†³æ–‡ä»¶åé—®é¢˜çš„æ–¹æ¡ˆæ˜¯æ·»åŠ ä¸€ä¸ª 8.3 è·¯å¾„åˆ°è¿™ä¸ªæ–‡ä»¶ä¸Šå¹¶æ·»åŠ åˆ°è¯¥ç±»åº“ä¸Šã€‚å¦‚æœè¿™ä¸ªåº“éœ€è¦å»ºç«‹ä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶ï¼Œè¿™å°†ä¸å¯è¡Œã€‚å¦‚æœè·¯å¾„éå¸¸é•¿å¹¶ä¸”8.3æ ¼å¼æ¯” <code>MAX_PATH<code> é•¿ï¼Œè¿™ä¹Ÿå°†ä¸å¯è¡Œã€‚å¦‚æœåœ¨æ“ä½œç³»ç»Ÿè®¾ç½®ä¸­çŸ­åç”Ÿæˆä¸å¯è¡Œï¼Œè¿™ä»å°†ä¸å¯è¡Œã€‚</li>

	<li>åœ¨C++ä¸­ï¼Œé™¤äº†ä½¿ç”¨ UTF-8 ç¼–ç ï¼Œæ²¡æœ‰æ–¹æ³•èƒ½å¤Ÿä» <code>std::exception::what()</code> è¿”å› Unicodeã€‚é™¤äº†ä½¿ç”¨ UTF-8ï¼Œæ²¡æœ‰åˆ«çš„åŠæ³•ä½¿ Unicode æ”¯æŒ <code>localeconv</code>ã€‚</li>

	<li>UTF-16 åœ¨å½“ä»Šä»ç„¶æµè¡Œï¼Œå³ä½¿åœ¨ Windows ä¸–ç•Œä¹‹å¤–ã€‚Qtï¼ŒJavaï¼ŒC#ï¼ŒPythonï¼ˆåœ¨ CPython 3.3ç‰ˆæœ¬å‚è€ƒå®ç°ä¹‹å‰ï¼Œ<a href="#faq.python">å‚è€ƒ</a>ï¼‰å’Œ <a href="http://en.wikipedia.org/wiki/International_Components_for_Unicode"> ICU </a> â€”â€” ä»–ä»¬éƒ½æ˜¯ç”¨ UTF-16 ä½œä¸ºå†…éƒ¨å­—ç¬¦ä¸²è¡¨ç¤ºã€‚</li>
</ul>

<h2 id="cookie"><a class="aId" href="#cookie">é€æ˜æ•°æ®äº‰è®º</a></h2>

<p>è®©æˆ‘ä»¬å›åˆ°æ–‡ä»¶å¤åˆ¶å·¥å…·ã€‚åœ¨ UNIX ä¸–ç•Œä¸­ï¼Œçª„å­—ç¬¦ä¸²å‡ ä¹åˆ°å¤„è¢«é»˜è®¤ä¸º UTF-8 ç¼–ç ã€‚å› æ­¤ï¼Œæ–‡ä»¶å¤åˆ¶å·¥å…·çš„ä½œè€…ä¸éœ€è¦è€ƒè™‘ Unicodeã€‚ä¸€æ—¦ ASCII å­—ç¬¦ä¸²ä½œä¸ºæ–‡ä»¶åå‚æ•°æµ‹è¯•é€šè¿‡ï¼Œä»»ä½•å…¶ä»–è¯­è¨€çš„æ–‡ä»¶åéƒ½ä¼šå·¥ä½œæ­£å¸¸ï¼Œas arguments are treated as  <a href="http://en.wikipedia.org/wiki/Opaque_data_type">cookies</a>. å¤åˆ¶å·¥å…·çš„ä»£ç <em>ä¸€ç‚¹</em>ä¹Ÿä¸éœ€è¦æ”¹å˜å°±å¯ä»¥æ”¯æŒå…¶ä»–è¯­è¨€ã€‚<code>fopen()</code> æ— ç¼çš„æ¥æ”¶ Unicode å­—ç¬¦ï¼Œ<code>argv</code> ä¹ŸåŒæ ·å¦‚æ­¤ã€‚</p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€çœ‹åœ¨åŸºäº UTF-16 æ¶æ„çš„å¾®è½¯ Windows ä¸Šå¦‚ä½•å®ç°ã€‚åœ¨è¿™ä¸Šé¢åˆ¶ä½œä¸€ä¸ªèƒ½å¤Ÿæ¥å—å‡ ç§ä¸åŒçš„ Unicode å—å­—ç¬¦æ–‡ä»¶åå‚æ•°çš„æ–‡ä»¶å¤åˆ¶å·¥å…·éœ€è¦é«˜æ·±çš„æŠ€å·§ã€‚é¦–å…ˆï¼Œè¿™ä¸ªåº”ç”¨å¿…é¡»ç¼–è¯‘ä¸º Unicode æ„ŸçŸ¥çš„ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå®ƒä¸èƒ½æœ‰å¸¦æœ‰æ ‡å‡†Cå‚æ•°çš„ <code>main()</code> å‡½æ•°ã€‚å®ƒå°†æ¥å— UTF-16 ç¼–ç çš„ argvã€‚ä¸ºäº†ä½¿ä¸€ä¸ªæ ¸å¿ƒéƒ¨åˆ†ä½¿ç”¨ç”¨çª„å­—ç¬¦æ–‡æœ¬çš„ Windows åº”ç”¨ç¨‹åºæ¥æ”¶ Unicode å­—ç¬¦ï¼Œå®ƒå¿…é¡»æ·±å±‚æ¬¡çš„é‡æ„å¹¶ä¸”è®¤çœŸå¤„ç†æ¯ä¸€ä¸ªå­—ç¬¦ä¸²å˜é‡ã€‚</p>

<p>å’Œ MSVC ä¸€åŒå‘å¸ƒçš„æ ‡å‡†åº“æ²¡æœ‰å¾ˆå¥½çš„æ”¯æŒ Unicodeã€‚å®ƒç›´æ¥å°†çª„å­—ç¬¦ä¸²è½¬å‘åˆ°ç³»ç»Ÿçš„ ANSI APIã€‚æ²¡æœ‰åŠæ³•é‡å†™è¿™äº›ã€‚æ”¹å˜ <code>std::locale</code> ä¹Ÿæ— æ•ˆã€‚åœ¨ MSVC ä¸Šä½¿ç”¨ C++ çš„æ ‡å‡†ç‰¹æ€§æ— æ³•æ‰“å¼€ä¸€ä¸ªä½¿ç”¨ Unicode å­—ç¬¦åç§°çš„æ–‡ä»¶ã€‚æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶çš„æ ‡å‡†æ–¹æ³•æ˜¯ï¼š<p>

<pre><code>std::fstream fout(&quot;abc.txt&quot;);</code></pre>

<p>è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹å¼æ˜¯ä½¿ç”¨å¾®è½¯è‡ªèº«æ¥å—å®½å­—ç¬¦å‚æ•°çš„hackï¼Œä½†è¿™ä¸æ˜¯æ ‡å‡†çš„æ‰©å±•ã€‚</p>

<p>åœ¨ Windows ä¸Šï¼Œ<code>HKLM\SYSTEM\CurrentControlSet\Control\Nls\CodePage\ACP</code> æ³¨å†Œè¡¨é”®å€¼èƒ½å¤Ÿä½¿æ¥å—é ASCII å­—ç¬¦ï¼Œä½†æ˜¯è¿™äº›å­—ç¬¦åªèƒ½æ¥è‡ªå•ä¸ª ANSI å­—ç¬¦é¡µã€‚åœ¨ Windows ä¸Šï¼Œä¸€ä¸ªæœªè¢«å®ç°çš„å€¼ 65001 å°†èƒ½å¤Ÿè§£å†³ cookie é—®é¢˜ã€‚ å¦‚æœå¾®è½¯å®ç°å¯¹è¿™ä¸ª <abbr title="ANSI Code Page">ACP</abbr> å€¼çš„æ”¯æŒï¼Œè¿™å°†æœ‰åŠ©äº UTF-8 ç¼–ç åœ¨ Windows å¹³å°ä¸Šæ›´å¹¿æ³›çš„åº”ç”¨ã€‚</p>

<p>å¯¹äº Windows ç¨‹åºå‘˜å’Œå¤šå¹³å°åº“çš„å¼€å‘å•†ï¼Œæˆ‘ä»¬ä¼šåœ¨ <a href="#windows">Windowså¹³å°å¦‚ä½•å¤„ç†æ–‡æœ¬</a> éƒ¨åˆ†æ·±å…¥æ¢è®¨æˆ‘ä»¬ä¸ºäº†æ›´å¥½æ”¯æŒUnicode çš„å¤„ç†æ–‡æœ¬å­—ç¬¦ä¸²å’Œé‡æ„ç¨‹åºçš„æ–¹æ³•ã€‚</p>


<h2 id="characters"><a class="aId" href="#characters">Glyphs, graphemes å’Œå…¶å®ƒ Unicode ç±»å‹</a></h2>
    <p>è¿™é‡Œæœ‰ä¸€ä¸ªå¸¦æœ‰æˆ‘ä»¬è¯„è®ºçš„æŒ‰ç…§ Unicode æ ‡å‡†çš„å…³äºå­—ç¬¦ï¼Œç ç‚¹ï¼Œç å…ƒå’Œè±¡å½¢èšç°‡å®šä¹‰çš„æ‘˜å½•ã€‚ä½ å¯ä»¥å‚è€ƒæ ‡å‡†çš„ç›¸å…³éƒ¨åˆ†è·å–æ›´å¤šè¯¦ç»†çš„æè¿°ã€‚</p>

	<aside class="rightFloater"><p class="display" style="font-size:1.5em">ĞŸÑ€Ğ¸Ğ²ĞµÌÑ‚ à¤¨à¤®à¤¸à¥à¤¤à¥‡ ×©Ö¸××œ×•Ö¹×</p><p>ä½ çœ‹åˆ°äº†å¤šå°‘<em>å­—ç¬¦</em>ï¼Ÿ</p></aside>

	<dl>
		<dt>ç ç‚¹(code point)</dt>
		<dd>Unicode ç¼–ç ç©ºé—´çš„ä»»ä½•æ•°å€¼ã€‚<sup>[Â§3.4, D10]</sup> ä¸¾ä¾‹: U+3243F. </dd>

		<dt>ç å…ƒ(code unit)</dt>
        <dd>èƒ½å¤Ÿä»£è¡¨ä¸€ä¸ªç¼–ç æ–‡æœ¬å•å…ƒçš„æœ€å°ä½ç»„åˆã€‚<sup>[Â§3.9, D77]</sup> ä¸¾ä¾‹ï¼ŒUTF-8ï¼ŒUTF-16 å’Œ UTF-32 åˆ†åˆ«ä½¿ç”¨ 8ä½ï¼Œ16ä½å’Œ 32 ä½çš„ç å…ƒã€‚ä¸Šé¢æåˆ°çš„ç ç‚¹å°† ä¼šè¢«ç¼–ç ä¸º â€˜<code>f0 b2 90 bf</code>â€™ä½¿ç”¨UTF-8ï¼Œ'<code>d889 dc3f</code>' ä½¿ç”¨ UTF-16ï¼Œ '<code>0003243f</code>' ä½¿ç”¨ UTF-32ã€‚æ³¨æ„è¿™äº›ä»…ä»…æ˜¯<em>ä½ç»„(groups of bits)</em>çš„æ¬¡åºï¼›å®ƒä»¬å¦‚ä½• è¢«å­˜å‚¨è¿›ä¸€æ­¥å–å†³äºç›¸å…³ç¼–ç çš„ç«¯æ€§ã€‚æ‰€ä»¥ï¼Œå½“å­˜å‚¨ä¸Šé¢çš„ UTF-16 ç å…ƒåœ¨ä¸€ä¸ª octet çš„åª’ä»‹ä¸Šï¼Œä»–ä»¬å°†ä¼šè¢«è½¬åŒ–ä¸º '<code>d8 89 dc 3f</code>' åœ¨ UTF-16BE ç¼–ç ä¸­ï¼Œåœ¨ UTF-16LEä¸­åˆ™æ˜¯ '<code>89 d8 3f dc</code>' ã€‚<dd>

		<dt>æŠ½è±¡å­—ç¬¦(Abstract character)</dt>
		<dd>
			<p>ç”¨æ¥ç»„ç»‡ï¼Œæ§åˆ¶å’Œè¡¨ç¤ºæ–‡æœ¬æ•°æ®çš„ä¸€ç»„ä¿¡æ¯å•å…ƒã€‚<sup>[Â§3.4, D7]</sup> åœ¨ Â§3.1 ä¸­æ ‡å‡†è¿›ä¸€æ­¥è¯´æ˜ï¼š</p>

			<blockquote><p>å¯¹äº Unicode æ ‡å‡†ï¼Œ[...] è¿™ä¸ªå­—ç¬¦é›†æœ¬è´¨ä¸Šæ˜¯å¼€æ”¾çš„ã€‚å› ä¸ºUnicodeæ˜¯ä¸€ä¸ªé€šç”¨çš„ç¼–ç ï¼Œä»»ä½•è¢«ç¼–ç è¿‡çš„æŠ½è±¡å­—ç¬¦éƒ½å°†æ˜¯è¢«ç¼–ç çš„å€™é€‰ï¼Œä¸ç®¡è¿™ä¸ªå­—ç¬¦ç°åœ¨æ˜¯å¦ä¸ºäººä»¬æ‰€çŸ¥ã€‚</p></blockquote>

			<p>è¿™ä¸ªå®šä¹‰çœŸçš„å¾ˆæŠ½è±¡ã€‚ä»»ä½•äººä»¬èƒ½å¤Ÿæƒ³åˆ°å¯ä»¥<em>ä½œä¸º</em>å­—ç¬¦éƒ½æ˜¯ä¸€ä¸ªæŠ½è±¡å­—ç¬¦ã€‚ä¸¾ä¸ªä¾‹å­ <img src="data/glyph-ungwe.png" style="vertical-align: -1ex" alt=""/> <em>tengwar å­—æ¯ ungwe</em>æ˜¯ä¸€ä¸ªæŠ½è±¡å­—ç¬¦ï¼Œè™½ç„¶å®ƒè¿˜ä¸èƒ½åœ¨ Unicode ä¸­è¡¨ç¤ºã€‚</p>

		</dd>

		<dt>ç¼–ç å­—ç¬¦(Encoded character)</dt>
		<dt>Coded character</dt>
		<dd>
			<p>ä¸€ä¸ªç ç‚¹å’Œä¸€ä¸ªæŠ½è±¡å­—ç¬¦çš„æ˜ å°„ã€‚<sup>[Â§3.4, D11]</sup> ä¸¾ä¾‹ï¼ŒU+1F428 æ˜¯ä¸€ä¸ªå·²ç¼–ç å­—ç¬¦ï¼Œä»£è¡¨æŠ½è±¡å­—ç¬¦ ğŸ¨ <span class="uniname">è€ƒæ‹‰</span>.</p>

			<p>è¿™ç§æ˜ å°„æ—¢ä¸æ˜¯å®Œæ•´çš„ï¼Œä¹Ÿä¸æ˜¯å•å°„ï¼Œä¹Ÿä¸æ˜¯æ»¡å°„ï¼š</p>

			<ul>
				<li>ä»£è¡¨ï¼Œéå­—ç¬¦å’Œæœªåˆ†é…çš„ç ç‚¹ä¸å¯¹åº”æŠ½è±¡å­—ç¬¦ã€‚</li>
				<li>ä¸€äº›æŠ½è±¡å­—ç¬¦å¯ä»¥ä½¿ç”¨ä¸åŒçš„ç ç‚¹ç¼–ç ï¼› U+03A9 <span class="uniname">å¸Œè…Šå¤§å†™å­—æ¯ omega</span> å’Œ U+2126 <span class="uniname">æ¬§å§†ç¬¦å·</span> éƒ½å¯¹åº”ç›¸åŒçš„æŠ½è±¡å­—ç¬¦ 'Ï€' ï¼Œå¹¶ä¸”<em>å¿…é¡»è¢«åŒæ ·çš„çœ‹å¾…</em>ã€‚</li>
				<li>ä¸€äº›æŠ½è±¡å­—ç¬¦ä¸èƒ½è¢«ä¸€ä¸ªå•ä¸€ç ç‚¹ç¼–ç ã€‚å®ƒä»¬ç”¨å·²ç¼–ç å­—ç¬¦<em>åºåˆ—</em>è¡¨ç¤ºã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œè¡¨ç¤ºæŠ½è±¡å­—ç¬¦ ÑÌ <em>cyrillic small letter yu with acute</em> çš„å”¯ä¸€æ–¹æ³•æ˜¯ç”¨åºåˆ— U+044E <span class="uniname"></span> ç´§è·Ÿ U+0301 <span class="uniname">combining acute accent</span>ã€‚</li>
			</ul>

			<p> è¿˜æœ‰ï¼Œå¯¹äºä¸€äº›æŠ½è±¡å­—ç¬¦ï¼Œé™¤äº†ä½¿ç”¨å•ç ç‚¹çš„å·²ç¼–ç å­—ç¬¦çš„å½¢å¼ï¼Œ<em>è¿˜</em>å­˜åœ¨ç€ä½¿ç”¨å¤šç ç‚¹çš„è¡¨ç¤ºæ–¹æ³•ã€‚æŠ½è±¡å­—ç¬¦ Çµ å¯ä»¥ç”¨å•ä¸€ç ç‚¹ U+01F5 <span class="uniname">latin small letter g with acute</span>ç¼–ç ï¼Œæˆ–è€…è¢« &lt;U+0067 <span class="uniname">latin small letter g</span>, U+0301 <span class="uniname">combining acute accent</span>&gt åºåˆ—ç¼–ç ã€‚</p>
		</dd>

		<dt>ç”¨æˆ·æ„ŸçŸ¥å­—ç¬¦(User-perceived character)</dt>
		<dd>ä»»ä½•ç»ˆç«¯ç”¨æˆ·çœ‹ä¸ºä¸€ä¸ªå­—ç¬¦çš„å­—ç¬¦ã€‚è¿™ä¸ªæ¦‚å¿µæ˜¯ä¾èµ–äºè¯­è¨€çš„ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œ'ch' åœ¨è‹±è¯­å’Œæ‹‰ä¸è¯­ä¸­æ˜¯ä¸¤ä¸ªå­—æ¯ï¼Œä½†æ˜¯ åœ¨æ·å…‹è¯­å’Œ Slovak ä¸­è¢«çœ‹åšä¸€ä¸ªå­—æ¯ã€‚</dd>

		<dt>å­—å½¢æ—(Grapheme cluster)</dt>
		<dd>ä¸€ä¸ªåº”è¯¥ä¿æŒåœ¨ä¸€èµ·çš„å·²ç¼–ç å­—ç¬¦åºåˆ—ã€‚<sup>[Â§2.11]</sup>å­—å½¢æ—åœ¨å•ç‹¬è¯­è¨€çš„è§’åº¦çœ‹æ¥è¿‘ç”¨æˆ·æ„ŸçŸ¥å­—ç¬¦ã€‚ä»–ä»¬è¢« ç”¨æ¥åšå…‰æ ‡ç§»åŠ¨å’Œé€‰æ‹©ã€‚</dd>
	</dl>

	<p>å­—ç¬¦å¯èƒ½æ„å‘³ç€ä¸Šé¢çš„ä»»æ„å®šä¹‰ã€‚Unicode æ ‡å‡†å°†å®ƒä½œä¸º<em>å·²ç¼–ç å­—ç¬¦</em>çš„åŒä¹‰è¯[Â§3.4]ã€‚å½“ä¸€äº›ç¼–ç¨‹è¯­è¨€æˆ–è€…åº“æ–‡ä»¶è¯´åˆ°â€˜å­—ç¬¦â€™ï¼Œè¿™æ€»æ˜¯æ„å‘³ç€ä¸€ä¸ªç å…ƒã€‚å½“ä¸€ä¸ªç»ˆç«¯ç”¨æˆ·è¢«é—®åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­å­—ç¬¦çš„æ•°é‡çš„æ—¶å€™ï¼Œå¥¹å°†è®¡æ•°ç”¨æˆ·å¯Ÿè§‰çš„å­—ç¬¦ã€‚æ ¹æ®ä¸€ä¸ªç¨‹åºå‘˜çš„çš„ Unicode ç†Ÿæ‚‰ç¨‹åº¦ï¼Œä»–ä¼šå°†ç å…ƒï¼Œç ç‚¹æˆ– grapheme èšç°‡æ•°åšå­—ç¬¦ã€‚ä¾‹å¦‚ï¼Œ <a href="https://dev.twitter.com/docs/counting-characters">æ¨ç‰¹å¦‚ä½•è®¡ç®—å­—ç¬¦æ•°é‡</a>ã€‚æˆ‘ä»¬è®¤ä¸ºï¼Œå¯¹å­—ç¬¦ä¸² 'ğŸ¨â€™'ï¼Œä¸€ä¸ªæ±‚å­—ç¬¦ä¸²é•¿åº¦å‡½æ•°ä¸ä¸€æ ·ä¸€å®šè¿”å› 1 æ‰æ˜¯å…¼å®¹ Unicode çš„ã€‚</p>

<h2 id="asian"><a class="aId" href="#asian">äºšæ´²æ–‡å­—: UTF-8 vs. UTF-16</a></h2>
	<p>å¤§å¤šæ•°çš„ Unicode ç ç‚¹ä½¿ç”¨ UTF-8 å’Œ UTF-16 ç¼–ç å æ®ç›¸åŒçš„å­—èŠ‚æ•°ã€‚è¿™åŒ…æ‹¬ä¿„ç½—æ–¯æ–‡ï¼Œå¸Œä¼¯æ¥æ–‡ï¼Œå¸Œè…Šæ–‡ã€‚å¹¶ä¸”æ‰€æœ‰çš„ non-BMP ï¼ˆéåŸºæœ¬é¢ï¼‰ç ç‚¹åœ¨ä¸¤ç§ç¼–ç ä¸­éƒ½å æœ‰2ä¸ªæˆ–4ä¸ªå­—èŠ‚ã€‚å°½ç®¡ä¸€äº›äºšæ´²å­—ç¬¦ä½¿ç”¨ UTF-8 å ç”¨æ›´å¤šç©ºé—´ï¼Œä½¿ç”¨ UTF-16 ç¼–ç ä¼šåœ¨æ‹‰ä¸å­—æ¯ï¼Œæ ‡ç‚¹ç¬¦å·å’Œå…¶ä½™çš„ ASCII å­—ç¬¦ä¸Šå ç”¨æ›´å¤šçš„ç©ºé—´ã€‚äºšæ´²ç¨‹åºå‘˜ä»¬æ€ä¹ˆèƒ½å¤Ÿä¸åå¯¹æ”¾å¼ƒæ¯ä¸ªå­—ç¬¦èŠ‚çœä»–ä»¬ 50% å†…å­˜çš„çš„ UTF-16ç¼–ç å‘¢ï¼Ÿ</p>

	<p>äº‹å®ä¸Šï¼Œåªæœ‰åœ¨äººä¸ºæ„å»ºçš„ä»…åŒ…å« U+0800 åˆ° U+FFFF èŒƒå›´å†…å­—ç¬¦çš„ä¾‹å­ä¸­æ‰æ˜¯è¿™æ ·ã€‚ç„¶è€Œï¼Œç”µè„‘å’Œç”µè„‘é—´çš„æ–‡æœ¬æ¥å£æ¯”æ–‡æœ¬çš„å…¶ä»–åº”ç”¨è¦å¹¿æ³›ã€‚è¿™åŒ…å« XMLï¼ŒHTTPï¼Œç³»ç»Ÿè·¯å¾„å’Œé…ç½®æ–‡ä»¶â€”â€”ä»–ä»¬å‡ ä¹éƒ½ä½¿ç”¨ç‹¬å®¶çš„ ASCII å­—ç¬¦ï¼Œå¹¶ä¸”äº‹å®ä¸Šåœ¨ç›¸å…³çš„äºšæ´²å›½å®¶ UTF-8 ä½¿ç”¨çš„åŒæ ·å¤šã€‚</p>

	<p>å¯¹äºä¸­æ–‡ä¹¦çš„ä¸“é—¨å­˜å‚¨ï¼ŒUTF-16 ä¾æ—§å¯ä»¥è¢«ä½¿ç”¨æ¥ä½œä¸ºä¸é”™çš„ä¼˜åŒ–ã€‚ä¸€æ—¦æ–‡æœ¬ä»è¿™æ ·çš„å­˜å‚¨ä¸­å–å‡ºæ¥ï¼Œå®ƒåº”è¯¥è¢«è½¬æ¢ä¸ºå’Œä¸–ç•Œç›¸å…¼å®¹çš„æ ‡å‡†ã€‚åœ¨ä¸¤ç§æƒ…å†µä¸‹ï¼Œå¦‚æœå­˜å‚¨æ˜¯æ˜‚è´µçš„ï¼Œæ— æŸå‹ç¼©æ€»æ˜¯ä¼šè¢«ä½¿ç”¨ã€‚åœ¨è¿™æ ·çš„æƒ…å†µä¸‹ï¼ŒUTF-8 å’Œ UTF-16 å°†å æ®å¤§è‡´å·®ä¸å¤šçš„ç©ºé—´ã€‚è¿›ä¸€æ­¥ï¼Œâ€œåœ¨è¯­è¨€ä¸­ï¼Œä¸€ä¸ªè±¡å½¢æ–‡å­—æ¯”æ‹‰ä¸å­—ç¬¦ä¼ é€’æ›´å¤šçš„ä¿¡æ¯ï¼Œæ‰€ä»¥å®ƒå æ®æ›´å¤šçš„ç©ºé—´ä¹Ÿå¾ˆåˆç†â€ (Tronic, <a href="http://programmers.stackexchange.com/a/102211/34925">UTF-16 considered harmful</a>)ã€‚</p>

	<p>è¿™é‡Œæœ‰ä¸€ä¸ªç®€å•å®éªŒçš„ç»“æœã€‚ä¸€äº›ç½‘é¡µï¼ˆæ—¥è¯­æ–‡ç« ï¼Œ2012å¹´1æœˆ1æ—¥é‡‡é›†äºæ—¥è¯­ç»´åŸºç™¾ç§‘ï¼‰çš„ HTML æºæ–‡ä»¶å æ®çš„ç©ºé—´åœ¨ç¬¬ä¸€çºµåˆ—ã€‚ç¬¬äºŒçºµåˆ—æ˜¾ç¤ºçš„æ˜¯å»é™¤æ ‡è®°åçš„è¿™äº›æ–‡æœ¬çš„ç»“æœï¼Œå°±æ˜¯é€‰æ‹©å…¨éƒ¨ï¼Œå¤åˆ¶ï¼Œç²˜è´´åˆ°çº¯æ–‡æœ¬æ–‡ä»¶ä¸­ã€‚</p>
	<table class="basicTable" style="width:100%">
		<tbody>
			<tr><th></th><th>HTML Source (Î” UTF-8)</th><th>Dense text (Î” UTF-8)</th></tr>
			<tr><th>UTF-8</th><td>767 KB (0%)</td><td>222 KB (0%)</td></tr>
			<tr><th>UTF-16</th><td>1â€‰186 KB (+55%)</td><td>176 KB (âˆ’21%)</td></tr>
			<tr><th>UTF-8 zipped</th><td>179 KB (âˆ’77%)</td><td>83 KB (âˆ’63%)</td></tr>
			<tr><th>UTF-16LE zipped</th><td>192 KB (âˆ’75%)</td><td>76 KB (âˆ’66%)</td></tr>
			<tr><th>UTF-16BE zipped</th><td>194 KB (âˆ’75%)</td><td>77 KB (âˆ’65%)</td></tr>
		</tbody>
	</table>

	<p>å¯ä»¥çœ‹å‡ºï¼ŒUTF-16 åœ¨å®é™…æ•°æ®ä¸Šå æ®çš„ç©ºé—´æ¯” UTF-8 å¤š 50%ï¼Œå¯¹äºçº¯äºšæ´²æ–‡å­—ä»…ä»…èŠ‚çº¦ 20% çš„ç©ºé—´å¹¶ä¸”åœ¨ç”¨é€šç”¨å‹ç¼©ç®—æ³•å¤„ç†åå¾ˆéš¾æœ‰ç«äº‰åŠ›ã€‚</p>

<h2 id="textops"><a class="aId" href="#textops">ç¼–ç å­—ç¬¦ä¸²çš„æ–‡æœ¬æ“ä½œ</a></h2>
	<p>æµè¡Œçš„åŸºäºæ–‡æœ¬çš„æ•°æ®æ ¼å¼ï¼ˆå¦‚CSV, XML, HTML, JSON, RTFå’Œè®¡ç®—æœºç¨‹åºçš„æºç ï¼‰ç»å¸¸åŒ…å« ASCII å­—ç¬¦ä½œä¸ºç»“æ„æ§åˆ¶å…ƒç´ å¹¶ä¸”åŒ…å«ASCIIå’ŒéASCIIæ•°æ®å­—ç¬¦ä¸²ã€‚å¤„ç†ASCIIå­—ç¬¦ç ç‚¹é•¿åº¦æ¯”å…¶ä»–ç ç‚¹é•¿åº¦çŸ­çš„å˜é•¿ç¼–ç ä¼¼ä¹æ˜¯ä¸€ä¸ªå›°éš¾çš„ä»»åŠ¡ï¼Œå› ä¸ºå­—ç¬¦ä¸²å†…çš„ç¼–ç å­—ç¬¦çš„ç•Œé™ä¸æ˜¯ç«‹å³å¯çŸ¥çš„ã€‚è¿™ä½¿å¾—è½¯ä»¶æ¶æ„é€‰æ‹© UCS-4 å®šé•¿ç¼–ç (ä¾‹å¦‚ï¼Œ<a href="#faq.python">Python v3.3</a>)ã€‚äº‹å®ä¸Šï¼Œè¿™æ—¢æ˜¯ä¸å¿…è¦çš„ï¼Œä¹Ÿå¹¶æ²¡æœ‰è§£å†³æˆ‘ä»¬çŸ¥é“çš„ä»»ä½•å®é™…é—®é¢˜ã€‚</p>

	<p>è‡ªUTF-8è®¾è®¡ä¹‹åˆï¼ŒUTF-8 ä¿è¯ä¸€ä¸ª ASCII å­—ç¬¦å€¼æˆ–è€…å­ä¸²æ°¸è¿œä¸ä¼šåŒ¹é…åˆ°ä¸€ä¸ªå¤šå­—èŠ‚ç¼–ç å­—ç¬¦çš„ä¸€éƒ¨åˆ†ã€‚UTF-16ä¹Ÿæ˜¯è¿™æ ·ã€‚åœ¨ä¸¤ç§ç¼–ç ä¸­ï¼Œå¤šéƒ¨åˆ†ç¼–ç ç ç‚¹çš„ç å…ƒä¼šå°†<abbr title="Most Significant Bit">MSB</abbr> è®¾ç½®ä¸º1ã€‚</p>

	<p>â€˜&lt;â€™ ç¬¦å·æ ‡å¿—ç€ä¸€ä¸ª HTML æ ‡ç­¾çš„å¼€å§‹ï¼Œæˆ–è€…ä¸€ä¸ªUTF-8 ç¼–ç çš„ SQL è¯­å¥ä¸­çš„ï¼ˆ`ï¼‰é˜²æ­¢ SQL æ³¨å…¥ï¼Œæ­£å¦‚ä½ è®²ä½œä¸ºä¸€ä¸ªå…¨è‹±è¯­çš„æ–‡æœ¬ ASCII å­—ç¬¦ä¸²ã€‚ç¼–ç ä¿è¯è¿™ä¸ªèƒ½å¤Ÿè¿è¡Œã€‚ç‰¹åˆ«åœ°ï¼Œæ¯ä¸€ä¸ªé ASCII å­—ç¬¦éƒ½ä½œä¸ºå­—èŠ‚åºåˆ—ç¼–ç ä¸ºUTF-8çš„ï¼Œåºåˆ—ä¸­çš„æ¯ä¸€ä¸ªéƒ½æœ‰ä¸€ä¸ªå¤§äº 127 çš„å€¼ã€‚è¿™ä½¿å¾—åŸæœ‰çš„ç®—æ³•ä¸å¯èƒ½å‘ç”Ÿç¢°æ’ --- ç®€å•ï¼Œå¿«é€Ÿå’Œä¼˜é›…ï¼Œå¹¶ä¸”ä¸éœ€è¦åœ¨æ„å·²ç¼–ç å­—ç¬¦è¾¹ç•Œã€‚ </p>

	<p> å¹¶ä¸”ï¼Œåœ¨ä»ä¸€ä¸ª UTF-8 ç¼–ç å­—ç¬¦ä¸²ä¸­æŸ¥æ‰¾ä¸€ä¸ªéASCIIï¼ŒUTF-8 ç¼–ç çš„å­ä¸²æ—¶ä½ å¯ä»¥å°†å®ƒçœ‹åšä¸€ä¸ªçº¯å­—èŠ‚æ•°ç»„ï¼Œä¸éœ€è¦å…³å¿ƒç ç‚¹çš„è¾¹ç•Œã€‚è¿™å½’åŠŸäº UTF-8 ç¼–ç çš„å¦ä¸€ä¸ªè®¾è®¡ç‰¹æ€§----ä¸€ä¸ªç ç‚¹å‰é¢çš„å­—èŠ‚æ°¸è¿œä¸èƒ½ä¸ä»»ä½•å…¶ä»–ç ç‚¹çš„åé¢çš„å­—èŠ‚ä¹‹ä¸€æœ‰ç›¸åŒçš„å€¼ã€‚</p>

<h2 id="myths"><a class="aId" href="#myths">è®¡ç®—å­—ç¬¦ä¸Šçš„æ›´æ·±çš„è°œé¢˜</a></h2>

<p>æ­£å¦‚æˆ‘ä»¬å·²ç»è¯´æ˜çš„ï¼Œåœ¨ä¸€ä¸ª Unicode å­—ç¬¦ä¸²ä¸­è®¡æ•°ï¼Œåˆ†å‰²ï¼Œç´¢å¼•å’Œå…¶ä»–éå†ç ç‚¹çš„æ“ä½œåº”è¯¥è¢«è§†ä¸ºç»å¸¸å’Œé‡è¦çš„æ“ä½œã€‚åœ¨è¿™éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†è®¤çœŸåœ°é‡çœ‹è¿™éƒ¨åˆ†ã€‚</p>

<h3 id="myth.utf16.o1"><a class="aId" href="#myth.utf16.o1">1. ä½¿ç”¨ UTF-16ï¼Œè®¡ç®—å­—ç¬¦æ•°å¯ä»¥åœ¨ä¸€ä¸ªå¸¸é‡æ—¶é—´å†…å®Œæˆã€‚</a></h3>

<p>è¿™æ˜¯é‚£äº›è®¤ä¸º UTF-16 æ˜¯ä¸€ä¸ªå›ºå®šå®½åº¦ç¼–ç çš„äººçš„ä¸€ä¸ªå…±æœ‰é”™è¯¯ã€‚ä¸æ˜¯è¿™æ ·çš„ï¼Œäº‹å®ä¸Š UTF-16 æ˜¯åšä¸€ä¸ªå˜é•¿ç¼–ç ã€‚å¦‚æœä½ ä¾ç„¶å¦è®¤éBMP å­—ç¬¦çš„å­˜åœ¨ï¼Œå‚è€ƒ<a href="#faq.almostfw">è¿™ä¸ªå¸¸è§é—®é¢˜é›†</a>ã€‚</p>

<h3 id="myth.utf32.o1"><a class="aId" href="#myth.utf32.o1">2. ä½¿ç”¨ UTF-32ï¼Œè®¡ç®—å­—ç¬¦æ•°é‡å¯ä»¥åœ¨ä¸€ä¸ªå¸¸é‡æ—¶é—´å†…å®Œæˆã€‚</a></h3>

<p>è¿™å–å†³äºè¢«è¯¯ç”¨çš„è¯è¯­ â€˜å­—ç¬¦â€™ çš„å«ä¹‰ã€‚åœ¨ UTF-32 ä¸­ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥åœ¨å¸¸æ•°æ—¶é—´å†…è®¡æ•°ç å…ƒå’Œç ç‚¹ã€‚ç„¶è€Œï¼Œç ç‚¹ å¹¶ä¸ä¸€å®šå¯¹åº”ç”¨æˆ·å¯è§‰çš„å­—ç¬¦ã€‚å³ä½¿åœ¨ Unicode å½¢å¼ä¸­ä¸€äº›ç ç‚¹å¯¹åº”<em>ç¼–ç å­—ç¬¦</em>ï¼Œä¸€äº›å¯¹åº”<em>éå­—ç¬¦</em>ã€‚</p>

<h3 id="myth.strlen"><a id="myth.nth.char"></a><a class="aId" href="#myth.strlen">3. ç»™å·²ç¼–ç å­—ç¬¦æˆ–è€…ç ç‚¹è®¡æ•°æ˜¯é‡è¦çš„</a></h3>

<p>ç ç‚¹çš„é‡è¦æ€§ç»å¸¸è¢«å¤¸å¤§ã€‚è¿™æ˜¯ç”±äºå¯¹ä»…ä»…åæ˜ äººç±»è¯­è¨€å¤æ‚æ€§çš„ Unicode å¤æ‚åº¦çš„è¯¯è§£ã€‚å¾ˆå®¹æ˜“è¯´å‡ºåœ¨ 'Abracadabra' ä¸­æœ‰å¤šå°‘ä¸ªå­—ç¬¦ï¼Œä½†æ˜¯å¯¹äºä¸‹é¢çš„å­—ç¬¦ä¸²å´å¹¶ä¸æ˜¯é‚£ä¹ˆç®€å•ï¼š</p>

<p class="display">ĞŸÑ€Ğ¸Ğ²ĞµÌÑ‚ à¤¨à¤®à¤¸à¥à¤¤à¥‡ ×©Ö¸××œ×•Ö¹×</p>

<p>ä¸Šé¢çš„å­—ç¬¦ä¸²åŒ…å« 22(!) ç ç‚¹ï¼Œä½†ä»…ä»…æœ‰ 16 ä¸ªè±¡å½¢æ—ã€‚æ‰€ä»¥ï¼Œâ€˜Abracadabraâ€™ åŒ…å« 11 ä¸ªç ç‚¹ï¼Œä¸Šé¢çš„å­—ç¬¦ä¸²åŒ…å« 22 ä¸ªç ç‚¹ï¼Œå¦‚æœè½¬æ¢ä¸º<a href="http://unicode.org/reports/tr15/">NFC</a> åˆ™è¿›ä¸€æ­¥ä»…æœ‰ 20 ä¸ªç ç‚¹ã€‚ç„¶è€Œï¼Œç ç‚¹çš„æ•°é‡å’Œå‡ ä¹ä¸ä»»ä½•è½¯ä»¶å·¥ç¨‹é—®é¢˜æ— å…³ï¼Œå”¯ä¸€çš„ä¾‹å¤–æ˜¯å°†å­—ç¬¦ä¸²è½¬ä¸º UTF-32ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p>

<ul>
	<li>For cursor movement, text selection and alike, <em>grapheme clusters</em> shall be used. <!-- 5.11 --></li>
	<li>å¯¹äºå…‰æ ‡ç§»åŠ¨ï¼Œæ–‡æœ¬é€‰æ‹©ï¼Œ<em>è±¡å½¢æ—(grapheme clusters)</em> å°†ä¼šè¢«ä½¿ç”¨ã€‚</li>
	<li>å¯¹äºåœ¨è¾“å…¥é¢†åŸŸï¼Œæ–‡æœ¬æ ¼å¼ï¼Œåè®®å’Œæ•°æ®åº“ä¸Šé™åˆ¶å­—ç¬¦ä¸²é•¿åº¦çš„æƒ…å†µï¼Œé•¿åº¦æ˜¯æ ¹æ®æå‰æŒ‡å®šçš„ç¼–ç çš„<em>ç å…ƒ</em>æµ‹ç®—å‡ºæ¥çš„ã€‚åŸå› æ˜¯ä»»ä½•é•¿åº¦é™åˆ¶æ˜¯æ¥æºäºåœ¨ä½å±‚æ¬¡ç»™å­—ç¬¦ä¸²åˆ†é…çš„å›ºå®šé‡çš„å†…å­˜ï¼Œåœ¨å†…å­˜ä¸­ï¼Œç£ç›˜ä¸­æˆ–è€…åœ¨ä¸€ä¸ªç‰¹å®šçš„æ•°æ®ç»“æ„ä¸­ã€‚</li>
	<li>å­—ç¬¦ä¸²åœ¨å±å¹•ä¸Šæ˜¾ç¤ºçš„å¤§å°å’Œå­—ç¬¦ä¸²ä¸­ç ç‚¹çš„æ•°é‡æ— å…³ã€‚ä¸ºäº†è§£è¿™äº›ï¼Œä¸å¾—ä¸é€šè¿‡æ¸²æŸ“å¼•æ“ã€‚ç ç‚¹ä¸å æ®ä¸€åˆ—å³ä½¿åœ¨ç»ˆç«¯å’Œç­‰å®½å­—ä½“ä¸­ã€‚POSIX è€ƒè™‘åˆ°äº†è¿™ç‚¹ã€‚</li>
</ul>

<h3 id="myth.nfc"><a class="aId" href="#myth.nfc">4. åœ¨ NFC ä¸­ï¼Œæ¯ä¸ªç ç‚¹å¯¹åº”ä¸€ä¸ªç”¨æˆ·å¯æŸ¥çš„å­—ç¬¦</a></h3>

<p>ä¸ï¼Œå› ä¸ºå¯ä»¥åœ¨ Unicode ä¸­è¡¨ç¤ºçš„ç”¨æˆ·å¯è§å­—ç¬¦çš„æ•°é‡æ˜¯æ— é™çš„ã€‚å³ä½¿åœ¨å®è·µä¸­ï¼Œå¤§å¤šæ•°å­—ç¬¦å¹¶æ²¡æœ‰ä¸€ä¸ªå®Œå…¨ç»„æˆçš„å½¢å¼ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¸Šé¢ä¾‹å­ä¸­çš„åŒ…å«ä¸‰ä¸ª<em>çœŸå®</em>è¯­è¨€çš„ä¸‰ä¸ª<em>çœŸå®</em>è¯è¯­çš„ NFD å­—ç¬¦ä¸²å°†åœ¨ NFC ä¸­åŒ…å« 20 ä¸ªç ç‚¹ã€‚è¿™è¿œæ¯”å®ƒåŒ…å«çš„ 16 ä¸ªå¯è§å­—ç¬¦å¤šã€‚</p>

<h3 id="myth.strlen.correctness"><a class="aId" href="#myth.strlen.correctness">5. <code>length()</code> å­—ç¬¦ä¸²æ“ä½œä¸€å®šè®¡ç®—ç”¨æˆ·å¯è§å­—ç¬¦æˆ–è€…å·²ç¼–ç å­—ç¬¦çš„æ•°é‡ã€‚å¦‚æœä¸æ˜¯ï¼Œå®ƒå°±æ²¡èƒ½æ­£ç¡®åœ°æ”¯æŒ Unicodeã€‚</a></h3>

<p>ç¨‹åºåº“å’Œç¼–ç¨‹è¯­è¨€å¯¹ Unicode çš„æ”¯æŒç»å¸¸é€šè¿‡è¿”å›å­—ç¬¦ä¸²é•¿åº¦æ“ä½œçš„å€¼æ¥åˆ¤æ–­ã€‚æ ¹æ®å¯¹ Unicode æ”¯æŒçš„æµ‹è¯•ï¼Œå¤§å¤šæ•°æµè¡Œçš„è¯­è¨€ï¼Œä¾‹å¦‚ C#,Java ç”šè‡³è¿ ICU éƒ½ä¸æ”¯æŒ Unicodeã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¸€ä¸ªå­—ç¬¦ä¸² â€˜ğŸ¨â€™çš„é•¿åº¦åœ¨UTF-16 ä½œä¸ºå†…éƒ¨å­—ç¬¦ä¸²è¡¨ç¤ºçš„åœ°æ–¹ç»å¸¸è¢«æŠ¥å‘Šä¸º2ï¼Œåœ¨å†…éƒ¨ä½¿ç”¨ UTF-8 çš„è¯­è¨€ä¸­åˆ™æ˜¯ 4ã€‚è¯¯è§£çš„æ¥æºæ˜¯è¿™äº›è¯­è¨€çš„è¯´æ˜ä¸­ä½¿ç”¨å­—ç¬¦è¡¨ç¤ºä¸€ä¸ªç å…ƒï¼Œå°½ç®¡ç¨‹åºå‘˜å¸Œæœ›å®ƒæ˜¯å…¶å®ƒçš„ä¸œè¥¿ã€‚</p>

<p>å› æ­¤ï¼Œè¿™äº› API è¿”å›çš„ç å…ƒæ•°å®é™…ä¸Šéå¸¸é‡è¦ã€‚å½“å†™ä¸€ä¸ª UTF-8 å­—ç¬¦ä¸²åˆ°ä¸€ä¸ªæ–‡ä»¶ï¼Œæœ€é‡è¦çš„æ˜¯å­—èŠ‚æ•°çš„é•¿åº¦ã€‚è®¡æ•°ä»»ä½•ç±»å‹çš„å­—ç¬¦ï¼Œå¹¶ä¸æ˜¯éå¸¸æœ‰ç”¨ã€‚</p>

<h2 id="conclusions"><a class="aId" href="#conclusions">æˆ‘ä»¬çš„ç»“è®º</a></h2>

<p>UTF-16 çš„ä¸¤ä¸ªæ–¹é¢éƒ½æ˜¯æœ€ç³Ÿç³•çš„ï¼Œé•¿åº¦å¯å˜å’Œå¤ªå®½ã€‚å®ƒå› ä¸ºå†å²çš„åŸå› è€Œå­˜åœ¨ï¼Œé€ æˆäº†è®¸å¤šçš„è¿·æƒ‘ã€‚æˆ‘ä»¬å¸Œæœ›å®ƒçš„ä½¿ç”¨è¿›ä¸€æ­¥å‡å°‘ã€‚</p>

<p>å¯ç§»æ¤æ€§ï¼Œè·¨å¹³å°åä½œå’Œç®€å•æ€§è¿™äº›éƒ½æ¯”å’Œç°æœ‰å¹³å°çš„ APIs ç›¸å®¹æ›´é‡è¦ã€‚æ‰€ä»¥ï¼Œæœ€å¥½çš„æ–¹æ¡ˆæ˜¯åœ¨ Windows ä¸Šæ¯ä¸ªåœ°æ–¹éƒ½ä½¿ç”¨ UTF-8 çª„å­—ç¬¦ä¸²å¹¶ä¸”åœ¨è°ƒç”¨æ¥æ”¶å­—ç¬¦ä¸²çš„ APIs å‰å°†å®ƒä»¬æ¥å›è½¬æ¢ã€‚å½“å¤„ç†æ¥æ”¶å­—ç¬¦ä¸²çš„ç³»ç»Ÿ APIs æ—¶ï¼Œ <a href="#faq.cvt.perf">æ€§èƒ½å‡ ä¹ä¸ä¸æ­¤ç›¸å…³</a>ï¼Œä½†æ˜¯åœ¨å„ä¸ªåœ°æ–¹ä½¿ç”¨ç›¸åŒçš„ç¼–ç æœ‰å·¨å¤§çš„å¥½å¤„ï¼Œ<a href="#faq.liberal">æˆ‘ä»¬æ²¡æœ‰è¶³å¤Ÿçš„ç†ç”±ä¸å»è¿™ä¹ˆåšã€‚</a></p>

<p>è¯´åˆ°æ€§èƒ½ï¼Œæœºå™¨ç»å¸¸ä½¿ç”¨å­—ç¬¦ä¸²è¿›è¡Œé€šä¿¡ï¼ˆå¦‚HTTTPå¤´ï¼ŒXMLï¼‰ã€‚è®¸å¤šäººå°†æ­¤è§†ä¸ºé”™è¯¯ï¼Œè™½ç„¶è¿™å‡ ä¹æ€»æ˜¯é€šè¿‡è‹±æ–‡å®Œæˆï¼Œåœ¨è¿™ä¸ªæ–¹é¢ç»™äº† UTF-8 æ›´å¤šçš„ä¼˜åŠ¿ã€‚ä¸åŒçš„å­—ç¬¦ä¸²ä½¿ç”¨ä¸åŒçš„ç¼–ç å¢åŠ äº†å¤æ‚åº¦å’Œå› æ­¤é€ æˆçš„ bugsã€‚</p>

<p>å°¤å…¶ï¼Œæˆ‘ä»¬è®¤ä¸ºç»™ C++ å¢åŠ  <code>wchar_t</code> ç±»å‹æ˜¯ä¸€ä¸ªé”™è¯¯ï¼ŒC++11æ·»åŠ çš„ Unicode è¡¥å……ä¹Ÿä¸€æ ·ã€‚è™½ç„¶è¿™æ ·ï¼Œæœ€éœ€è¦å®ç°çš„æ˜¯<em>åŸºæœ¬æ‰§è¡Œå­—ç¬¦é›†</em>èƒ½å¤Ÿå­˜å‚¨ä»»ä½• Unicode æ•°æ®ã€‚ç„¶åï¼Œæ¯ä¸ª <code>std::string</code> æˆ–è€… <code>char*</code> å‚æ•°éƒ½å¿…é¡»æ˜¯ Unicode å…¼å®¹çš„ã€‚ â€˜åªè¦æ¥å—æ–‡æœ¬ï¼Œå°±æ˜¯åº”è¯¥æ˜¯ Unicode å…¼å®¹çš„'â€”â€”ä½¿ç”¨ UTF-8ï¼Œè¿™ç‚¹å¾ˆå®¹æ˜“åšåˆ°ã€‚</p>

<p><a href="http://www.boost.org/doc/libs/1_58_0/libs/locale/doc/html/rationale.html">è¿™ä¸ªæ ‡å‡†çš„éƒ¨åˆ†æœ‰è®¸å¤šè®¾è®¡ç‘•ç–µ</a>ã€‚è¿™åŒ…æ‹¬ <code>std::numpunct</code>ï¼Œ<code>std::moneypunct</code> å’Œ <code>std::ctype</code> éƒ½ä¸æ”¯æŒå˜é•¿ç¼–ç å­—ç¬¦ï¼ˆéASCIIçš„ UTF-8 å’Œ é BMP çš„ UTF-16ï¼‰ã€‚ä»–ä»¬å¿…é¡»è¢«ä¿®æ­£ï¼š</p>

<ul>
	<li><code>decimal_point()</code>å’Œ<code>thousands_sep()</code>åº”è¯¥è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²è€Œä¸æ˜¯ä¸€ä¸ªç å…ƒã€‚è¿™å°±æ˜¯ C locales é€šè¿‡<code>localeconv</code>å‡½æ•°æ”¯æŒè¿™ä¸ªï¼Œå°½ç®¡å¹¶ä¸å¯å®šåˆ¶ã€‚</li>

	<li><code>toupper()</code>å’Œ<code>tolower()</code> åœ¨å’Œç å…ƒï¼ˆcode unitsï¼‰ç›¸å…³çš„æ—¶å€™ä¹Ÿä¸åº”è¯¥è¢«ä½¿ç”¨ï¼Œå› ä¸ºå®ƒä¸æ”¯æŒåœ¨ Unicode ä¸‹å·¥ä½œã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œæ‹‰ä¸è¿ä½“å­—ç¬¦ ffl å¿…é¡»è¢«è½¬æ¢æˆ FFLï¼Œå¾·è¯­ ÃŸ å¿…é¡»è¢«è½¬åŒ–ä¸º SSï¼ˆæœ‰ä¸€ä¸ªå¤§å†™å½¢å¼çš„áºï¼Œä½†æ˜¯è½¬åŒ–è§„åˆ™éµå¾ªä¼ ç»Ÿçš„æ–¹å¼ï¼‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä¸€äº›è¯­è¨€ï¼ˆä¾‹å¦‚å¸Œè…Šè¯­ï¼‰æœ‰ä¸€äº›å°å†™å­—æ¯çš„æœ€ç»ˆç‰¹æ®Šå½¢å¼ï¼Œè¿™ç§æƒ…å†µä¸‹è½¬æ¢å¿…é¡»æ¸…æ¥šæ­£ç¡®åœ°è¿›è¡Œè½¬æ¢çš„ä½ç½®ã€‚</li>
</ul>


<h2 id="windows"><a class="aId" href="#windows">åœ¨ Windows ä¸Šå¦‚ä½•å¤„ç†æ–‡æœ¬</a></h2>

<p>è¿™éƒ¨åˆ†æ˜¯ä¸ºäº†å¤šå¹³å°åº“å¼€å‘å’Œ Windows å¹³å°ç¼–ç¨‹ã€‚Windows å¹³å°çš„é—®é¢˜æ˜¯å®ƒä¸æ”¯æŒä¸ Unicode å…¼å®¹çš„çª„å­—ç¬¦ä¸²ç³»ç»Ÿ APIsã€‚å°† Unicode å­—ç¬¦ä¸²ä¼ ç»™ Windows API çš„å”¯ä¸€æ–¹å¼æ˜¯é€šè¿‡è½¬åŒ–æˆ UTF-16ï¼ˆå³å®½å­—ç¬¦ï¼‰ã€‚</p>

<p>æ³¨æ„æˆ‘ä»¬çš„è¯´æ˜å’Œå¾®è½¯çš„å…³äº Unicode è½¬æ¢çš„åŸå§‹è¯´æ˜æ˜¾è‘—ä¸åŒã€‚æˆ‘ä»¬åŸºäºå®æ–½å®½å­—ç¬¦è½¬æ¢çš„æ–¹æ³•å°½å¯èƒ½ä¸ API è°ƒç”¨ç›¸è¿‘ï¼Œå¹¶ä¸”ä¸å¤„ç†å®½å­—ç¬¦æ•°æ®ã€‚åœ¨ä¸Šä¸€éƒ¨åˆ†æˆ‘ä»¬è§£é‡Šäº†è¿™å°†å¯¼è‡´æ›´å¥½çš„æ€§èƒ½ï¼Œç¨³å®šæ€§ï¼Œä»£ç ç®€ä»‹å’Œå…¶ä»–è½¯ä»¶æ›´å¥½çš„é›†æˆã€‚</p>

<ul>
	<li>ä¸è¦åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨ <code>wchar_t</code>æˆ–<code>std::wstring</code>ï¼Œé™¤éåœ¨å’Œæ¥å— UTF-16 çš„APIsçš„ä¸´è¿‘ç‚¹ã€‚</li>

	<li>ä¸è¦åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨ <code>_T(&quot;&quot;)</code> æˆ– <code>L&quot;&quot;</code>ä¿®è¾ï¼Œé™¤éç”¨åœ¨æ¥å— UTF-16 çš„APIsçš„å‚æ•°ä¸Šã€‚</li>

	<li>ä¸è¦ä½¿ç”¨å¯¹ <code>UNICODE</code> å¸¸é‡æ•æ„Ÿçš„ç±»å‹ï¼Œå‡½æ•°æˆ–è€…ä»–ä»¬çš„è¡ç”Ÿç‰©ï¼Œä¾‹å¦‚<code>LPTSTR</code>, <code>CreateWindow()</code>æˆ–<code>_T()</code>å®ã€‚ç›¸åï¼Œä½¿ç”¨<code>LPWSTR</code>, <code>CreateWindowW()</code>å’Œæ˜ç¡®çš„<code>L""</code>å­—ç¬¦é‡ã€‚</li>

    <li>ä¸ºäº†é¿å…ä¼ é€’ç»™ ANSI WinAPI çš„ UTF-8 å­—ç¬¦ä¸²è¢«æ‚„æ‚„åœ°ç¼–è¯‘ï¼Œ<code>Unicode</code> å’Œ <code>_UNICODE</code> ä»æ€»æ˜¯è¦è¢«å®šä¹‰ã€‚è¿™ä¸ªå¯ä»¥é€šè¿‡ VS é¡¹ç›®è®¾ç½®ä¸­çš„<em>ä½¿ç”¨ Unicode å­—ç¬¦é›†</em>è®¾å®š</li>

    <li>ç¨‹åºä¸­ä»»ä½•åœ°ç‚¹å‡ºç°çš„ <code>std::string</code> å’Œ <code>char*</code> éƒ½è¢«çœ‹åš UTF-8 ã€‚</li>

    <li>å¦‚æœä½ æœ‰å¹¸å†™ C++ï¼Œä¸‹é¢çš„ <code>narrow()</code>/<code>widen()</code> è½¬æ¢å‡½æ•°å¯¹äº inline è½¬æ¢è¯­æ³•éå¸¸æ–¹ä¾¿ã€‚å½“ç„¶ï¼Œä»»ä½•å…¶ä»– UTF-8/UTF-16 è½¬æ¢ä»£ç éƒ½å¯ä»¥ã€‚</li>

	<li>
		åªä½¿ç”¨æ¥å—å®½å­—ç¬¦ï¼ˆ<code>LPWSTR</code>ï¼‰çš„ Win32 å‡½æ•°ï¼Œç»ä¸ä½¿ç”¨é‚£äº›æ¥å— <code>LPTSTR</code> æˆ– <code>LPSTR</code> çš„å‡½æ•°ã€‚ç”¨è¿™ç§æ–¹æ³•ä¼ é€’å‚æ•°ï¼š
		<pre><code>::SetWindowTextW(widen(someStdString or &quot;string litteral&quot;).c_str())</code></pre>
		å®è·µ (Policy) ä½¿ç”¨ä¸‹é¢æè¿°çš„è½¬æ¢å‡½æ•°ã€‚å‚è€ƒï¼Œ<a href="#faq.cvt.perf">ä¸€ä¸ªå…³äºè½¬æ¢æ•ˆç‡çš„ç¬”è®°</a>.
	</li>

	<li>
		å¯¹äº MFC ä¸­çš„å­—ç¬¦ä¸²ï¼š
		<pre><code>CString someoneElse; // something that arrived from MFC.

// Converted as soon as possible, before passing any further away from the API call:
std::string s = str(boost::format(&quot;Hello %s\n&quot;) % narrow(someoneElse));
AfxMessageBox(widen(s).c_str(), L&quot;Error&quot;, MB_OK);</code></pre>
	</li>

	<li>å¯¹äº.NETå¼€å‘è€…: ä½¿ç”¨åŸå§‹çš„åŸºäº UTF-16 çš„å­—ç¬¦ä¸²ç±»ä¹Ÿè®¸å¾ˆéš¾é¿å…ã€‚è®°ä½è¿™ä¸ªå®ç°ç»†èŠ‚é€šè¿‡ç±»çš„æ¥å£æœ‰é‡å¤§ç¼ºé™·ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œ<code>string[index]</code> æ“ä½œä¹Ÿè®¸ä¼šè¿”å›ä¸€ä¸ªå­—ç¬¦çš„éƒ¨åˆ†ï¼ˆå°±åƒå¤„ç†ä¸€ä¸ª UTF-8 å­—èŠ‚åºåˆ—ï¼‰ã€‚å½“åºåˆ—åŒ–å­—ç¬¦ä¸²åˆ°æ–‡ä»¶æˆ–é€šè®¯è®¾å¤‡çš„æ—¶å€™ï¼Œè®°å¾—æ˜ç¡® <code>Encoding.UTF8</code>ã€‚å‡†å¤‡å¥½ä¸ºäº†è½¬æ¢ä»˜å‡ºæ•ˆç‡ä»£ä»·ã€‚ä¾‹å¦‚ï¼Œåœ¨äº§ç”Ÿ UTF-8 HTMLè¾“å‡ºçš„ ASP.NET webåº”ç”¨ä¸­ã€‚</li>

</ul>

<h3 id="how.files"><a class="aId" href="#how.files">åœ¨ Windows ä¸Šå¤„ç†æ–‡ä»¶ï¼Œæ–‡ä»¶åå’Œå­—ç¬¦æµ</a></h3>

<ul>
	<li>æ€»æ˜¯ç”Ÿæˆ UTF-8 ç¼–ç çš„æ–‡æœ¬è¾“å‡ºæ–‡ä»¶ã€‚</li>

	<li>å› ä¸º <a href="http://en.wikipedia.org/wiki/RAII">RAII/OOD</a> çš„åŸå› ï¼Œä½¿ç”¨ <code>fopen()</code> åº”è¯¥è¢«é¿å…ã€‚ä½†æ˜¯å¦‚æœå¿…è¦ï¼ŒæŒ‰ç…§ä¸Šé¢æè¿°çš„æ–¹å¼ä½¿ç”¨ <code>_wfopen()</code> å’Œ WinAPIã€‚</li>

	<li>æ°¸è¿œä¸è¦ä¼ é€’ <code>std::string</code> å’Œ <code>const char*</code> æ–‡ä»¶åå‚æ•°ç»™ <code>fstream</code> å®¶æ—ã€‚MSVC CRT ä¸æ”¯æŒ UTF-8 å‚æ•°ï¼Œä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªéæ ‡å‡†çš„æ‰©å±•åº”è¯¥æŒ‰ä¸‹é¢çš„æ–¹å¼ä½¿ç”¨ã€‚</li>

	<li>
		ä½¿ç”¨ <code>widen</code> å°† <code>std::string</code> å‚æ•°è½¬åŒ–ä¸º <code>std::wstring</code>ï¼š
		<pre><code>std::ifstream ifs(widen(&quot;hello&quot;), std::ios_base::binary);</code></pre>
		å½“ MSVC å¯¹äº <code>fstream</code> çš„æ€åº¦å˜åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸æ‰‹åŠ¨å»é™¤è¯¥è½¬æ¢ã€‚
	<li>è¯¥ä»£ç ä¸æ˜¯å¤šå¹³å°çš„å¹¶ä¸”åœ¨å°†æ¥ä¹Ÿè®¸ä¼šä¸å¾—ä¸æ‰‹åŠ¨æ”¹å˜ã€‚</li>
	<li>ä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨ä¸€ç»„å°è£…å»éšè—è½¬åŒ–ã€‚</li>
</ul>

<h3 id="how.cvt"><a class="aId" href="#how.cvt">è½¬åŒ–å‡½æ•°</a></h3>

<p>è¿™ä»½æŒ‡å—ä½¿ç”¨çš„è½¬åŒ–å‡½æ•°æ¥è‡ª <a href="http://cppcms.com/files/nowide/html/">Boost.Nowide library</a>(è¿˜ä¸æ˜¯ boost çš„ä¸€éƒ¨åˆ†)ï¼š</p>

<pre><code>std::string narrow(const wchar_t *s);
std::wstring widen(const char *s);
std::string narrow(const std::wstring &amp;s);
std::wstring widen(const std::string &amp;s);</code></pre>

<p>è¿™ä¸ªåº“ä¹Ÿä¸ºå¸¸ç”¨çš„å¤„ç†æ–‡ä»¶å’Œä½¿ç”¨ iostreams è¯»å†™ UTF-8 çš„C å’Œ C++ åº“å‡½æ•°æä¾›äº†ä¸€ç»„å°è£…ã€‚</p>

<p>è¿™äº›å‡½æ•°å’Œå°è£…é€šè¿‡ Windows çš„ <code>MultiByteToWideChar</code> å’Œ <code>WideCharToMultiByte</code> å‡½æ•°å¾ˆå®¹æ˜“å®ç°ã€‚ä»»ä½•å…¶å®ƒ ï¼ˆä¹Ÿè®¸æ›´å¿«çš„ï¼‰è½¬åŒ–æ–¹æ³•ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚</p>


<h2 id="faq"><a class="aId" href="#faq">å¸¸è§é—®é¢˜</a></h2>

<ol class="faqList">
	<li>
		<h3 id="faq.linuxer"><a class="aId" href="#faq.linuxer">é—®ï¼šä½ æ˜¯ä¸€ä¸ª Linux ä½¿ç”¨è€…å—ï¼Ÿè¿™æ˜¯ä¸€åœºéšè—çš„åå¯¹ Windows çš„å®—æ•™æˆ˜äº‰å—ï¼Ÿ</a></h3>
		<p>ç­”ï¼šä¸ï¼Œæˆ‘ä½¿ç”¨ Windows é•¿å¤§ï¼Œå¹¶ä¸”æˆ‘åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ª Windows å¼€å‘è€…ã€‚æˆ‘è®¤ä¸ºä»–ä»¬åœ¨æ–‡æœ¬æ–¹é¢åšå‡ºäº†ä¸€ä¸ªé”™è¯¯çš„é€‰æ‹©ï¼Œå› ä¸ºä»–ä»¬æ¯”å…¶ä»–äººåšçš„éƒ½æ—©ã€‚ â€”â€” Pavel</p>
	</li>

	<li>
		<h3 id="faq.anglophile"><a id="faq.angle.saxon"></a><a class="aId" href="#faq.anglophile">é—®ï¼šä½ æ˜¯ä¸€ä¸ªäº²è‹±æ´¾ç ï¼Ÿä½ æ˜¯å¦ç§ä¸‹è®¤ä¸ºè‹±è¯­å­—æ¯å’Œæ–‡åŒ–æ¯”å…¶å®ƒè¦ä¼˜è¶Šï¼Ÿ</a></h3>
		<p>ç­”ï¼šä¸ï¼Œå¹¶ä¸”æˆ‘çš„å›½å®¶ä¹Ÿå¹¶ä¸æ˜¯è®² ASCII ä¸Šå­—ç¬¦çš„è¯­è¨€çš„å›½å®¶ã€‚æˆ‘ä¸è®¤ä¸ºä½¿ç”¨ä¸€ä¸ªå­—èŠ‚ç¼–ç  ASCII å­—ç¬¦çš„ç¼–ç æ˜¯ç›æ ¼é²ä¸­å¿ƒä¸»ä¹‰æ€æƒ³ï¼Œæˆ–è€…ä¸äººä»¬æ²Ÿé€šæœ‰ä»»ä½•çš„å…³ç³»ã€‚å³ä½¿ä¸€ä¸ªäººå¯ä»¥äº‰è¾©è¯´ç¨‹åºï¼Œç½‘é¡µå’Œ XML æ–‡ä»¶ï¼Œæ“ä½œç³»ç»Ÿæ–‡ä»¶åå’Œå…¶å®ƒç”µè„‘å’Œç”µè„‘çš„æ¥å£æœ¬ä¸åº”è¯¥å­˜åœ¨ï¼Œåªè¦ä»–ä»¬å­˜åœ¨ï¼Œæ–‡æœ¬å°±ä¸ä»…ä»…æ˜¯ç»™äººç±»è¯»è€…çš„ã€‚</p>
	</li>

	<li>
		<h3 id="faq.why.care"><a class="aId" href="#faq.why.care">é—®ï¼šä½ ä»¬è¿™äº›äººä¸ºä»€ä¹ˆåœ¨æ„ï¼Ÿæˆ‘ä½¿ç”¨ C# å’Œ/æˆ– Java ç¼–ç¨‹ï¼Œæˆ‘ä¸€ç‚¹ä¹Ÿä¸åœ¨æ„ç¼–ç ã€‚</a></h3>

		<p>ç­”ï¼šä¸å¯¹ã€‚å€¼å¾—åº†ç¥çš„æ˜¯ï¼ŒC# å’Œ Java éƒ½æä¾› 16 ä½ï¼Œå°äº Unicode å­—ç¬¦é›†çš„ <code>char</code> ç±»å‹ã€‚.NET ç´¢å¼• <code>str[i]</code> å·¥ä½œåœ¨å†…éƒ¨è¡¨ç¤ºå•å…ƒï¼Œå› æ­¤åˆå‡ºç°ä¸€ä¸ªæœ‰æ¼æ´çš„æŠ½è±¡ã€‚å­ä¸²æ–¹æ³•å°†ä¼šè¿”å›ä¸€ä¸ªæ— æ•ˆçš„å­—ç¬¦ä¸²ï¼Œå°†ä¸€ä¸ªé BMP å­—ç¬¦åˆ†æˆå‡ éƒ¨åˆ†ã€‚</p>

		<p>æ­¤å¤–ï¼Œå½“ä½ å°†æ–‡æœ¬å†™å…¥åˆ°ç£ç›˜ï¼Œç½‘ç»œé€šä¿¡ï¼Œå¤–éƒ¨è®¾å¤‡æˆ–å…¶ä»–ä»»ä½•ç¨‹åºä¼šè¯»å–åœ°æ–¹ä¸Šçš„æ–‡ä»¶çš„æ—¶å€™ï¼Œä½ ä¸å¾—ä¸åœ¨æ„ç¼–ç ã€‚ ä¸è¦ç®¡ä»»ä½•å¯¹å†…å®¹çš„å‡å®šï¼Œåœ¨è¿™äº›æƒ…å†µä¸€å®šè¦ä½¿ç”¨ <code>System.Text.Encoding.UTF8<code>(.Net) ï¼Œä¸è¦ä½¿ç”¨ <code>Encoding.ASCII<code>ï¼ŒUTF-16 æˆ–è€…æ‰‹æœºPDUã€‚</p>

		<p>Web æ¡†æ¶åƒ ASP.NET ä¹Ÿå—åˆ¶äºæ¡†æ¶ä¹‹ä¸‹å†…éƒ¨å­—ç¬¦ä¸²è¡¨ç¤ºé€‰æ‹©çš„åŒ®ä¹ï¼šä¸€ä¸ªç½‘ç»œåº”ç”¨é¢„æœŸçš„å­—ç¬¦ä¸²è¾“å‡ºï¼ˆæˆ–è€…è¾“å…¥ï¼‰å‡ ä¹æ€»æ˜¯ UTF-8 ç¼–ç ï¼Œå¯¼è‡´åœ¨é«˜è¾“å…¥è¾“å‡ºçš„ç½‘ç»œåº”ç”¨å’Œç½‘ç»œæœåŠ¡ä¸­é¢ä¸´å¤§é‡çš„è½¬æ¢ã€‚</p>
	</li>

	<li>
		<h3 id="faq.utf8.fossil"><a class="aId" href="#faq.utf8.fossil">é—®ï¼šUTF-8 ä¸å°±æ˜¯ä¸€ä¸ªå°è¯•å…¼å®¹ ASCII çš„ä¸€ä¸ªå°è¯•å—ï¼Ÿä¸ºä»€ä¹ˆè¦ä¿æŒè¿™ä¸ªè€åŒ–çŸ³?</a></h3>
		<p>ç­”ï¼šä¸ç®¡ UTF-8 æ˜¯ä¸æ˜¯ä½œä¸ºä¸€ä¸ªå…¼å®¹çš„ hack è¢«å‘æ˜å‡ºæ¥ã€‚ç°åœ¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¯”å…¶å®ƒä»»ä½•ç¼–ç éƒ½ä¼˜ç§€å’Œæµè¡Œçš„ç¼–ç ã€‚</p>
	</li>

	<li>
		<h3 id="faq.almostfw"><a class="aId" href="#faq.almostfw">Q: UTF-16 characters that take more than two bytes are extremely rare in the real world. This practically makes UTF-16 a fixed-width encoding, giving it a whole bunch of advantages. Canâ€™t we just neglect these characters?</a></h3>
		<p>A: Are you serious about not supporting all of Unicode in your software design? And, if you are going to support it anyway, how does the fact that non-BMP characters are rare practically change anything, except for making software testing harder? What does matter, however, is that text manipulations are relatively rare in real applicationsâ€”compared to just passing strings around as-is. This means the "almost fixed width" has little performance advantage (see Performance), while having shorter strings may be significant.</p>
	</li>

	<li>
		<h3 id="faq.liberal"><a class="aId" href="#faq.liberal">Q: Why not just let any programmer use their favorite encoding internally, as long as they knows how to use it?</a></h3>
		<p>A: We have nothing against correct usage of any encoding. However, it becomes a problem when the same type, such as <code>std::string</code>, means different things in different contexts. While it is â€˜ANSI codepageâ€™ for some, for others, it means â€˜this code is broken and does not support non-English textâ€™. In our programs, it means Unicode-aware UTF-8 string. This diversity is a source of many bugs and much misery. This additional complexity is something the world does not really need. The result is lots of Unicode-broken software, industry-wide. JoelOnSoftware <a href="http://www.joelonsoftware.com/articles/Unicode.html" rel="nofollow">suggests</a> that having every programmer be aware of encodings is the solution to Unicode-broken software. We believe that with one mainstream encoding becoming the default for software APIs, one will be able to write a correct file copy program <a href="#cookie">without being an expert in text and language issues</a>.</p>
	</li>

	<li>
		<h3 id="faq.win.liberal"><a class="aId" href="#faq.win.liberal">Q: My application is GUI-only. It does not do IP communications or file IO. Why should I convert strings back and forth all the time for Windows API calls, instead of simply using wide state variables?</a></h3>
		<p>This is a valid shortcut. Indeed, it may be a legitimate case for using wide strings. But, if you are planning to add some configuration or a log file in future, please consider converting the whole thing to narrow strings. That would be future-proof.</p>
	</li>

	<li>
		<h3 id="faq.def.unicode"><a class="aId" href="#faq.def.unicode">Q: Why do you turn on the <code>UNICODE</code> define, if you do not intend to use Windowsâ€™ <code>LPTSTR</code>/<code>TCHAR</code>/etc macros?</a></h3>
		<p>A: This is an additional safety mechanism against plugging a UTF-8 <code>char*</code> string into ANSI-expecting function variants of Windows API. We want it to generate a compiler error. It is the same kind of a hard-to-find bug as passing an <code>argv[]</code> string to <code>fopen()</code> on Windows: it assumes that the user will never pass non-current-codepage filenames. You will be unlikely to find this kind of a bug by manual testing, unless your testers are trained to supply Chinese file names occasionally, and yet it is a broken program logic. Thanks to the <code>UNICODE</code> define, you get a compiler error for that.</p>
	</li>

	<li>
		<h3 id="faq.naive"><a class="aId" href="#faq.naive">Q: Isnâ€™t it quite naÃ¯ve to think that Microsoft will stop using widechars one day?</a></h3>
		<p>A: Letâ€™s first see when they start supporting <code>CP_UTF8</code> as a valid codepage. This should not be very hard to do. Then, we see no reason why any Windows developer would continue using the widechar APIs. Also, adding support for <code>CP_UTF8</code> would â€˜unbreakâ€™ some of existing unicode-broken programs and libraries.</p>

		<p>Some say that adding <code>CP_UTF8</code> support would <em>break</em> existing applications that use the ANSI API, and that this was supposedly the reason why Microsoft had to resort to creating the wide string API. This is not true. Even some popular ANSI encodings are variable length (Shift JIS, for example), so no correct code would become broken. The reason Microsoft chose UCS-2 is purely historical. Back then UTF-8 hasnâ€™t yet existed, Unicode was believed to be â€˜just a wider ASCIIâ€™, and it was cosidered important to use a fixed-width encoding.</p>
	</li>

	<li>
		<h3 id="faq.boms"><a class="aId" href="#faq.boms">Q: What do you think about Byte Order Marks?</a></h3>
		<p>A: According to the Unicode Standard (v6.2, p.30): <q>Use of a BOM is neither required nor recommended for UTF-8</q>.</p>
		<p>Byte order issues are yet another reason to avoid UTF-16. UTF-8 has no endianness issues, and the UTF-8 BOM exists only to manifest that this is a UTF-8 stream. If UTF-8 remains the only popular encoding (as it already is in the internet world), the BOM becomes redundant. In practice, most UTF-8 text files omit BOMs today.</p>
		<p>Using BOMs would require all existing code to be aware of them, even in simple scenarios as file concatenation. This is unacceptable.</p>
	</li>

	<li>
		<h3 id="faq.crlf"><a class="aId" href="#faq.crlf">Q: What do you think about line endings?</a></h3>
		<p>A: Always use <code>\n (0x0a)</code> line endings, even on Windows. Files should be read and written in binary mode, which guarantees interoperabilityâ€”a program will always give the same output on any system. Since the C and C++ standards use <code>\n</code> as in-memory line endings, this will cause all files to be written in the POSIX convention. It may cause trouble when the file is opened in Notepad on Windows; however, any decent text editor understands such line endings.</p>
		<p>We also prefer SI units, the <a href="https://en.wikipedia.org/?title=ISO_8601" rel="nofollow">ISO-8601</a> date format, and floating point to the <a href="https://en.wikipedia.org/wiki/Decimal_mark#Countries_using_Arabic_numerals_with_decimal_comma" rel="nofollow">floating comma</a>.</p>
	</li>

	<li>
		<h3 id="faq.uni.perf"><a class="aId" href="#faq.uni.perf">Q: But what about performance of text processing algorithms, byte alignment, etc?</a></h3>
		<p>A: Is it really better with UTF-16? Maybe so. ICU uses UTF-16 for historical reasons, thus it is quite hard to measure. However, most of the times strings are treated as cookies, not sorted or reversed every second use. A denser encoding is then favorable for performance.</p>
	</li>

	<li>
		<h3 id="faq.utf16.fault"><a class="aId" href="#faq.utf16.fault">Q: Is it really a fault of UTF-16 that people misuse it, assuming that it is 16 bits per character?</a></h3>
		<p>A: Not really. But yes, safety is an important feature of every design, and encodings are no exception.</p>
	</li>

	<li>
		<h3 id="faq.confuse"><a class="aId" href="#faq.confuse">Q: If <code>std::string</code> means UTF-8, wouldnâ€™t that get confused with code that stores plain text in <code>std::string</code>s?</a></h3>
		<p>A: There is no such thing as plain text. There is no reason for storing codepage-ANSI or ASCII-only text in a class named â€˜stringâ€™.</p>
	</li>

	<li>
		<h3 id="faq.cvt.perf"><a class="aId" href="#faq.cvt.perf">Q: Wonâ€™t the conversions between UTF-8 and UTF-16 when passing strings to Windows slow down my application?</a></h3>

		<p>A: First, you will do <em>some</em> conversion either way. Itâ€™s either when calling the system, or when interacting with the rest of the world, e.g. when sending a text string over TCP. Also, those of OS APIs which accept strings often perform tasks which are inherently slow, such as UI or file system operations. If your interaction with the system APIs dominate your application, here is a little experiment.</p>

		<p>One typical use of the OS APIs is to open files. This function executes in (184â€‰Â±â€‰3)Î¼s on my machine:</p>

		<pre><code>void f(const wchar_t* name)
{
    HANDLE f = CreateFile(name, GENERIC_WRITE, FILE_SHARE_READ, 0, CREATE_ALWAYS, 0, 0);
    DWORD written;
    WriteFile(f, &quot;Hello world!\n&quot;, 13, &amp;written, 0);
    CloseHandle(f);
}</code></pre>

		<p>While this runs in (186â€‰Â±â€‰0.7)Î¼s:</p>

		<pre><code>void f(const char* name)
{
    HANDLE f = CreateFile(widen(name).c_str(), GENERIC_WRITE, FILE_SHARE_READ, 0, CREATE_ALWAYS, 0, 0);
    DWORD written;
    WriteFile(f, &quot;Hello world!\n&quot;, 13, &amp;written, 0);
    CloseHandle(f);
}</code></pre>

		<p>(Run with <code>name=&quot;D:\\a\\test\\subdir\\subsubdir\\this is the sub dir\\a.txt&quot;</code> in both cases. It was averaged over 5 runs. We used an optimized <code>widen</code> that relies on <code>std::string</code> contiguous storage guarantee given by C++11.)</p>

		<p>This is just (1â€‰Â±â€‰2)% overhead. Also, <code>MultiByteToWideChar</code> is not the fastest UTF-8â†”UTF-16 conversion function.</p>
	</li>

	<li>
		<h3 id="faq.literal"><a class="aId" href="#faq.literal">Q: How do I write UTF-8 string literal in my C++ code?</a></h3>

		<p>A: If you internationalize your software then all non-ASCII strings will be loaded from an external translation database, so it is not a problem.</p>

		<p>If you still want to embed a special character you can do it as follows. In C++11 you can do it as:</p>

		<p class="display"><code>u8&quot;âˆƒy âˆ€x Â¬(x â‰º y)&quot;</code></p>

		<p>With compilers that do not support â€˜u8â€™ you can hard-code the UTF-8 code units as follows:</p>

		<p class="display"><code>&quot;\xE2\x88\x83y \xE2\x88\x80x \xC2\xAC(x \xE2\x89\xBA y)&quot;</code></p>

		<p>However the most straightforward way is to just write the string as-is and save the source file encoded in UTF-8:</p>

		<p class="display"><code>&quot;âˆƒy âˆ€x Â¬(x â‰º y)&quot;</code></p>

		<p>Unfortunately, MSVC converts it to some ANSI codepage, corrupting the string. To work around this, save the file in UTF-8 <em>without BOM</em>. MSVC will assume that it is in the correct codepage and will not touch your strings. However, it renders it impossible to use Unicode identifiers and wide string literals (that you will not be using anyway).</p>
	</li>

	<li>
		<h3 id="faq.convert"><a class="aId" href="#faq.convert">Q: I have a complex large char-based Windows application. What is the easiest way to make it Unicode-aware?</a></h3>
		<p>Keep the chars. Define <code>UNICODE</code> and <code>_UNICODE</code> to get compiler errors where <code>narrow()</code>/<code>widen()</code> should be used (this is done automatically by setting <strong>Use Unicode Character Set</strong> in Visual Studio project settings). Find all <code>fstream</code> and <code>fopen()</code> uses, and use wide overloads as described above. By now, you are almost done.</p>
		<p>If you use 3rd-party libraries that do not support Unicode, e.g. forwarding file name strings as-is to <code>fopen()</code>, you will have to work around with tools such as <code>GetShortPathName()</code> as shown above.</p>
	</li>

	<li>
		<h3 id="faq.python"><a class="aId" href="#faq.python">Q: What about Python? I heard they worked hard in v3.3 to support Unicode better.</a></h3>
		<p>A: Perhaps, they should have done less and the support would have been better. In the CPython v3.3 reference implementation, the internal string representation was changed. The UTF-16 was replaced by one of three possible encodings (ISO-8859-1, UCS-2 or UCS-4) depending on the actual string content. To add a single non-ASCII or non-BMP character, the entire string will often be implicitly converted to a different encoding. The internal encoding is transparent to the script. This design is meant to <em>optimize the performance of indexing operations</em> on Unicode code points. However, we argue that counting or indexing code points <a href="#myth.strlen">should not be important</a> for the majority of usesâ€”compared, for instance, to grapheme clusters. To our knowledge, Python currently provides no support of the latter.</p>

		<p>Therefore, we oppose representation-agnostic handling of strings, in favor of representation-transparent API with a UTF-8 internal representation. Indexing operations would be counting code units rather than the code points, as they in fact did before the change. This would also simplify the implementation and also improve performance, e.g. in scripts dealing with the Web, which is already dominated by UTF-8 encoded text, thus making the Python programming language more applicable in the server-side world. One may argue about the safety of string-cutting operations by script programmers, but then again, the same argument is valid for splitting grapheme clusters. Even though Unicode is now fully supported, we believe that Python, as a modern tool with less historical burden to carry, must do better job in text handling.</p>

		<p>Other than that, JPython and IronPython continue to rely on the less fortunate encoding used by their hosting platforms (Java and .NET, respectively) and care must be taken to handle the surrogate pairs correctly there.</p>
	</li>

	<li>
		<h3 id="faq.ood"><a class="aId" href="#faq.ood">Q: But why <code>std::string</code>? Wouldnâ€™t it be a better, object-oriented approach to have a UTF-8 aware string class?</a></h3>
		<p>A: Not every piece of code dealing with strings is actually involved in processing and validation of text. A file copy program which receives Unicode file names and passes them to file IO routines, would do just fine with a simple byte buffer. If you design a library that accepts strings, the simple, standard and lightweight <code>std::string</code> would do just fine. On the contrary, it would be a mistake to reinvent a new string class and force everyone through your peculiar interface. Of course, if one needs more than just passing strings around, he should then use appropriate text processing tools. However, such tools are better to be independent of the storage class used, in the spirit of the container/algorithm separation in the STL. In fact, <a href="http://www.gotw.ca/gotw/084.htm">some consider</a> <code>std::string</code> interface too bloated, as most of it was better to be moved out of the <code>std::string</code> class.</p>
	</li>
	<li>
		<h3 id="faq.whats.now"><a class="aId" href="#faq.whats.now">Q: I already use this approach and I want to make our vision come true. What can I do?</a></h3>
		<p>A: Spread the word.</p>
		<p>Review your code and see what library is most painful to use in portable Unicode-aware code. Open a bug report to the authors. If you are a C or C++ library author, use <code>char*</code> and <code>std::string</code> with UTF-8 implied, and refuse to support ANSI code pagesâ€”since they are inherently Unicode-broken.</p>
		<p>If you are a Microsoft employee, push for implementing support of the <code>CP_UTF8</code> as one of narrow API code pages.</p>
		<p>Further ideas:</p>
		<ul>
			<li>Create a repository for patches of commonly used 3rd-party libraries for UTF-8 support (e.g. PugiXML, LibTIFF, etc.) These are written in standard C and do not care about Windows.</li>
			<li>Create a link-time patch for standard library functions (e.g. <code>fopen()</code>) on Windows, which would do the proper parameter conversion. This can be done for <code>main()</code> and the global environment variables.</li>
		</ul>
	</li>
</ol>


<h2 id="about"><a class="aId" href="#about">About the authors</a></h2>

<p>This manifesto was written by <a href="http://meshnotes.com/9SrRpAypTr8e">Pavel Radzivilovsky</a>, <a href="http://stannum.co.il/about">Yakov Galka</a> and <a href="http://slavanov.com/">Slava Novgorodov</a>. It is a result of our experience and research of real-world Unicode issues and mistakes done by real-world programmers. Our goal here is to improve awareness of text issues and to inspire industry-wide changes to make Unicode-aware programming easier, ultimately improving the experience of users of those programs written by human engineers. Neither of us is involved in the Unicode consortium.</p>

<p>Special thanks to Glenn Linderman for providing information about Python, and to Markus KÃ¼nne, Jelle Geerts and Lazy Rui for reporting bugs and typos in this document.</p>

<p>Much of the text was inspired by <a href="http://programmers.stackexchange.com/questions/102205/should-utf-16-be-considered-harmful">discussions on StackOverflow initiated by Artyom Beilis</a>, the author of Boost.Locale. Additional inspiration came from the development conventions at <a href="http://www.visionmap.com">VisionMap</a> and Michael Hartlâ€™s <a href="http://tauday.com/tau-manifesto">tauday.org</a>.</p>


<h2 id="extern"><a class="aId" href="#extern">External links</a></h2>

<ul>
	<li><a href="http://www.unicode.org/">The Unicode Consortium</a> (The Unicode Standard, <a href="http://www.unicode.org/versions/Unicode6.2.0/UnicodeStandard-6.2.pdf">PDF</a>)</li>

	<li><a href="http://site.icu-project.org/">International Components for Unicode</a> (ICU)</li>

	<li><a href="http://www.joelonsoftware.com/articles/Unicode.html">Joel on Unicode</a>â€”â€˜The Absolute Minimum Every Software Developer Absolutely, Positively Must Know About Unicode and Character Setsâ€™</li>

	<li><a href="http://cppcms.sourceforge.net/boost_locale/html/">Boost.Locale</a>â€”high quality localization facilities in a C++ way.</li>

	<li><a href="http://programmers.stackexchange.com/questions/102205/should-utf-16-be-considered-harmful">Should UTF-16 be considered harmful</a> on StackOverflow, started by Artyom Beilis.</li>

	<li><a href="https://dev.twitter.com/docs/counting-characters">How twitter counts characters</a></li>
</ul>

<h2 id="donate"><a class="aId" href="#donate">Feedback</a></h2>

<p>You can leave comments/feedback on the Facebook <a href="https://www.facebook.com/UTF8Everywhere">UTF-8 Everywhere</a> page. Your help and feedback are much appreciated.</p>

<p style="text-align:center">
<img src="data/utf8donate.png" alt="1UTF8gQmvChQ4MwUHT6XmydjUt9TsuDRn" /><br/>
Bitcoin donate to: 1UTF8gQmvChQ4MwUHT6XmydjUt9TsuDRn<br/>
The cash will be used for research and promotion.
</p>

<div id="g-plusone"></div>

<table class="layoutTable" style="border-top:1px solid silver; border-bottom:1px solid silver; padding:1ex 0ex; margin:1.5em 0 0.5em 0"><tr>
<td><a href="http://validator.w3.org/check?uri=referer"><img src="http://www.w3.org/Icons/valid-xhtml10" alt="Valid XHTML 1.0 Strict"/></a> <a href="http://jigsaw.w3.org/css-validator/check/referer"><img src="http://jigsaw.w3.org/css-validator/images/vcss" alt="Valid CSS!"/></a></td>
<td style="text-align:right">Last modified: <?php echo date("Y-m-d", getlastmod()); ?></td>
</tr></table>
</div>

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-31306173-1', 'auto');
ga('send', 'pageview');
</script>


<script type="text/javascript">
gapi.plusone.render("g-plusone", { "size":"standard", "count":"true", "href":"http://utf8everywhere.org/", "annotation":"inline" });
</script>

</body>
</html>
